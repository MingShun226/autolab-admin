<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>Autolabs - Component Stock Management</title>
    <style>
        :root {
            --primary-color: #52c41a;
            --secondary-color: #1890ff;
            --tertiary-color: #fa8c16;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --error-color: #f5222d;
            --info-color: #1890ff;
            --background-color: #f0f2f5;
            --sidebar-width: 225px;
            --header-height: 60px;
            --text-color: #333;
            --text-light: #666;
            --border-radius: 4px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #222;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
        }

        .logo-container {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #333;
            height: var(--header-height);
        }

        .logo {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .logo-text {
            font-size: 20px;
            font-weight: bold;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            padding: 10px 0;
            flex-grow: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #ddd;
            text-decoration: none;
            transition: all 0.3s;
            gap: 12px;
        }

        .nav-item:hover {
            background-color: #333;
        }

        .nav-item.active {
            background-color: #e21b1b;
            color: white;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-text {
            font-size: 14px;
        }

        /* Sub-item styles */
        .nav-item.sub-item {
            padding-left: 32px;
            font-size: 13px;
        }

        .nav-item.sub-item .nav-icon {
            width: 16px;
            height: 16px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
        }

        .header {
            height: var(--header-height);
            background-color: white;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            position: sticky;
            top: 0;
            z-index: 99;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: bold;
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
        }

        .dropdown-menu {
            position: absolute;
            top: 45px;
            right: -60px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            min-width: 200px;
            display: none;
            z-index: 100;
        }

        .dropdown-menu.active {
            display: block;
        }

        .dropdown-item {
            padding: 8px 16px;
            display: block;
            color: var(--text-color);
        }

        .dropdown-divider {
            height: 1px;
            background-color: #eee;
            margin: 8px 0;
        }

        .dropdown-item.logout {
            color: #e21b1b;
            cursor: pointer;
        }

        .dropdown-item.logout:hover {
            background-color: #f8f8f8;
        }

        .content {
            padding: 24px;
        }

        .page-title {
            font-size: 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .button {
            padding: 8px 16px;
            border-radius: var(--border-radius);
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .button.primary {
            background-color: var(--primary-color);
            color: white;
        }

        .button.primary:hover {
            background-color: #3fa00c;
        }

        .button.secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .button.secondary:hover {
            background-color: #096dd9;
        }

        .button.outline {
            background-color: white;
            color: var(--text-color);
            border: 1px solid #d9d9d9;
        }

        .button.outline:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* Dashboard Cards */
        .dashboard-overview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 16px;
            text-align: center;
        }

        .stat-title {
            color: var(--text-light);
            font-size: 13px;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
        }

        /* Panel Styles */
        .panel {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 24px;
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 500;
        }

        .panel-content {
            padding: 20px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #e8e8e8;
            overflow-x: auto;
            font-size: 14px;
            background-color: #fafafa;
            border-radius: 8px 8px 0 0;
            margin-bottom: 24px;
        }

        .tab {
            padding: 16px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
            white-space: nowrap;
            color: var(--text-light);
            background-color: transparent;
            border-right: 1px solid #e8e8e8;
        }

        .tab:last-child {
            border-right: none;
        }

        .tab:hover {
            color: var(--primary-color);
            background-color: rgba(232, 27, 27, 0.05);
        }

        .tab.active {
            color: var(--primary-color);
            font-weight: 600;
            background-color: white;
            border-bottom: 3px solid var(--primary-color);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 1px;
            background-color: var(--primary-color);
        }

        .tab-badge {
            display: inline-block;
            background-color: #f5f5f5;
            color: var(--text-light);
            border-radius: 10px;
            padding: 0 8px;
            font-size: 12px;
            margin-left: 8px;
        }

        /* Filter and Search */
        .filters-container {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .filter-label {
            font-size: 14px;
            color: var(--text-color);
            font-weight: 600;
            white-space: nowrap;
            min-width: max-content;
        }

        .filter-select,
        .filter-input {
            padding: 10px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            min-width: 140px;
            background-color: white;
            color: var(--text-color);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-select:focus,
        .filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(232, 27, 27, 0.1);
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 48px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            color: var(--text-color);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(232, 27, 27, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 16px;
        }

        /* Data Table */
        .data-table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            position: sticky;
            top: 0;
            background-color: #fafafa;
            text-align: left;
            padding: 16px;
            border-bottom: 2px solid #e8e8e8;
            color: var(--text-color);
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }

        .data-table td {
            padding: 16px;
            border-bottom: 1px solid #f5f5f5;
            vertical-align: top;
            font-size: 13px;
        }

        .data-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .data-table tbody tr:nth-child(even) {
            background-color: #fdfdfd;
        }

        .data-table tbody tr:nth-child(even):hover {
            background-color: #f8f9fa;
        }

        .product-name {
            white-space: normal;
            line-height: 1.4;
        }

        /* Component relationship display */
        .component-info {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .component-sku {
            background-color: #f0f2f5;
            padding: 4px 8px;
            border-radius: 6px;
            margin-right: 6px;
            margin-bottom: 4px;
            font-family: monospace;
            font-size: 12px;
            font-weight: 600;
            color: #4a4a4a;
            border: 1px solid #d9d9d9;
            display: inline-block;
        }

        .components-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            line-height: 1.8;
        }

        .limiting-component {
            border-color: var(--error-color) !important;
            background-color: #ffebee !important;
            color: var(--error-color) !important;
            font-weight: 700 !important;
        }

        /* Stock indicators */
        .stock-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stock-value {
            font-weight: 500;
        }

        .stock-value.high {
            color: var(--success-color);
        }

        .stock-value.medium {
            color: var(--warning-color);
        }

        .stock-value.low {
            color: var(--error-color);
        }

        .calculated-badge {
            background-color: var(--info-color);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            text-transform: uppercase;
        }

        /* Action buttons */
        .action-button {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-right: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .action-button.edit {
            background-color: #1890ff;
            color: white;
        }

        .action-button.edit:hover {
            background-color: #096dd9;
        }

        .action-button.components {
            background-color: #fa8c16;
            color: white;
        }

        .action-button.components:hover {
            background-color: #d46b08;
        }

        .action-button.add {
            background-color: #52c41a;
            color: white;
        }

        .action-button.add:hover {
            background-color: #389e0d;
        }

        .action-button.secondary {
            background-color: #f5f5f5;
            color: var(--text-color);
            border: 1px solid #d9d9d9;
        }

        .action-button.secondary:hover {
            background-color: #e6f7ff;
            border-color: #1890ff;
            color: #1890ff;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            animation: modalFadeIn 0.3s ease;
        }

        .modal-header-enhanced {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px 20px 32px;
            border-bottom: 2px solid var(--neutral-200);
            margin-bottom: 24px;
            background: linear-gradient(135deg, var(--neutral-50) 0%, var(--primary-50) 100%);
            border-radius: 12px 12px 0 0;
        }

        .modal-header-enhanced .close:hover {
            color: var(--primary-500);
            transform: scale(1.1);
        }

        /* Image Upload Styles */
        .image-upload-container {
            position: relative;
            border: 2px dashed #d1d5db !important;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f9fafb;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .image-upload-container:hover {
            border-color: #3b82f6 !important;
            background: #eff6ff;
        }

        .image-upload-container input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .upload-placeholder {
            color: var(--neutral-500);
        }

        .upload-placeholder svg {
            color: var(--neutral-400);
            margin-bottom: 12px;
        }

        .upload-placeholder p {
            margin: 8px 0 4px 0;
            font-weight: 500;
        }

        .upload-placeholder small {
            color: var(--neutral-400);
            font-size: 12px;
        }

        .image-preview {
            position: relative;
            text-align: center;
        }

        .remove-image-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 10;
            transition: all 0.3s ease;
        }

        .remove-image-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .remove-image-btn:active {
            transform: scale(0.95);
        }

        /* Loading animation */
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border: none;
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { 
                transform: translateY(-50px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 24px 24px 16px 24px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fafafa;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-color);
            font-size: 18px;
            font-weight: 600;
        }

        .modal-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 24px 24px 24px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background-color: #fafafa;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .close-button:hover {
            background-color: #f0f0f0;
            color: #666;
        }

        .close-button:active {
            background-color: #e0e0e0;
        }

        /* Modal Button Styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 80px;
            justify-content: center;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #c41e3a;
        }

        .btn-secondary {
            background-color: #f5f5f5;
            color: var(--text-color);
            border: 1px solid #d9d9d9;
        }

        .btn-secondary:hover {
            background-color: #e6f7ff;
            border-color: #1890ff;
            color: #1890ff;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }

        .form-control {
            display: block;
            width: 100%;
            padding: 12px 16px;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-color);
            background-color: white;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        textarea.form-control {
            height: auto;
            min-height: 80px;
        }

        .form-row {
            display: flex;
            gap: 16px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* Component preview styles */
        .component-preview-item {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid var(--neutral-300);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .component-preview-item strong {
            color: var(--primary-600);
            font-weight: 600;
        }
        
        .component-preview-item small {
            color: var(--neutral-600);
            font-size: 13px;
            font-weight: 500;
        }

        /* Component linking info */
        .component-linking-info {
            background: linear-gradient(135deg, #f6ffed 0%, #ffffff 100%);
            border: 2px solid #b7eb8f;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(183, 235, 143, 0.15);
        }

        .component-linking-info h4 {
            color: var(--success-color);
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 16px;
        }

        .component-linking-info p {
            color: var(--text-color);
            margin-bottom: 16px;
            font-size: 14px;
            line-height: 1.5;
            font-weight: 500;
        }

        .component-linking-info ul {
            margin: 0;
            padding-left: 24px;
        }

        .component-linking-info li {
            color: var(--text-color);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .rules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .rule-item {
            background-color: white;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #e8f5e8;
            text-align: center;
        }

        /* Product Detail View Styles */
        .product-detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e9ecef;
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            color: var(--text-color);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background-color: #e9ecef;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .product-detail-content {
            display: grid;
            gap: 32px;
        }

        .product-info-section, .product-variants-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #e9ecef;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }

        .variants-grid {
            display: grid;
            gap: 16px;
        }

        .variant-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .variant-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(232, 27, 27, 0.1);
        }

        .variant-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .variant-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
        }

        .variant-sku {
            font-size: 12px;
            color: var(--text-light);
            font-family: monospace;
            background-color: #f0f2f5;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .variant-components {
            margin-top: 12px;
        }

        .variant-components-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .product-basic-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
        }

        .rule-item strong {
            color: var(--text-color);
            display: block;
            margin-bottom: 4px;
        }

        .rule-item small {
            color: var(--text-light);
            font-size: 12px;
        }

        /* Loading spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Pagination */
        .table-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-top: 1px solid #f0f0f0;
        }

        .pagination {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-info {
            color: var(--text-light);
            font-size: 14px;
        }

        .page-button {
            width: 32px;
            height: 32px;
            margin: 0 2px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid #d9d9d9;
            background-color: white;
            transition: all 0.3s;
            font-weight: 500;
        }

        .page-button:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .page-button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .prev-page-button,
        .next-page-button {
            width: 32px;
            height: 32px;
            padding: 5px 10px;
            background-color: white;
            border: 1px solid #d9d9d9;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .prev-page-button.disabled,
        .next-page-button.disabled {
            color: #d9d9d9;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <div class="layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="logo-container">
                <svg class="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6Z" />
                </svg>
                <div class="logo-text">Autolabs</div>
            </div>

            <div class="nav-menu">
                <a href="dashboard.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </div>
                    <div class="nav-text">Dashboard</div>
                </a>
                <a href="order.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                        </svg>
                    </div>
                    <div class="nav-text">Order Management</div>
                </a>
                <a href="orderverification.html" class="nav-item">
                    <div class="nav-icon sub-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                    <div class="nav-text">Order Verification</div>
                </a>
                <a href="orderwarehouse.html" class="nav-item">
                    <div class="nav-icon sub-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 12h-6l-2 3h-4l-2-3H2"></path>
                            <path
                                d="m7 12 4 4 4-4M6 8l4-4 4 4">
                            </path>
                        </svg>
                    </div>
                    <div class="nav-text">Order warehouse</div>
                </a>
                <a href="stock.html" class="nav-item active">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                            </path>
                            <polygon points="3.27 6.96 12 12.01 20.73 6.96"></polygon>
                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                        </svg>
                    </div>
                    <div class="nav-text">Stock Management</div>
                </a>
                <a href="routemanagement.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                    </div>
                    <div class="nav-text">Route Management</div>
                </a>
                <a href="debt-management.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="10" y1="17" x2="14" y2="17"></line>
                        </svg>
                    </div>
                    <div class="nav-text">Debt Management</div>
                </a>
                <a href="customer.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <div class="nav-text">Customers</div>
                </a>
                <a href="staff.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="nav-text">Staff</div>
                </a>
                <a href="reports.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                    </div>
                    <div class="nav-text">Reports</div>
                </a>
            </div>
        </nav>

        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">AD</div>
                    <div>
                        <div style="font-weight: 500;" id="userName">Admin User</div>
                        <div style="font-size: 12px; color: var(--text-light);">Administrator</div>
                    </div>
                    <div class="dropdown-menu" id="userDropdown">
                        <div class="dropdown-item" id="userFullName">Admin User</div>
                        <div class="dropdown-item" id="userStaffId">Staff ID: 8888</div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item logout" id="logoutButton">Logout</div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="content">
                <div class="page-title">
                    <span>Component-Based Stock Management</span>
                    <div style="display: flex; gap: 12px;">
                        <button class="button outline" id="bulkUploadBtn">
                            📤 Bulk Upload
                        </button>
                        <button class="button outline" id="exportBtn">
                            📊 Export Data
                        </button>
                        <button class="button secondary" id="addComponentBtn">
                            🔧 Add Component
                        </button>
                        <button class="button primary" id="addProductBtn">
                            ➕ Add Product
                        </button>
                    </div>
                </div>

                <!-- Dashboard Overview -->
                <div class="dashboard-overview">
                    <div class="stat-card">
                        <div class="stat-title">Products</div>
                        <div class="stat-value" id="totalProducts">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Components</div>
                        <div class="stat-value" id="totalComponents">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Low Stock</div>
                        <div class="stat-value" id="lowStockAlerts" style="color: var(--error-color);">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Stock Value</div>
                        <div class="stat-value" id="stockValue">-</div>
                    </div>
                </div>

                <!-- Stock Management Panel -->
                <div class="panel">
                    <div class="tabs" id="stockTabs">
                        <div class="tab active" data-tab="components">Component Stock Management</div>
                        <div class="tab" data-tab="relationships">Product-Component Mapping</div>
                        <div class="tab" data-tab="products">Products Overview</div>
                    </div>

                    <div class="panel-content">
                        <!-- Products Tab -->
                        <div id="products-tab" class="tab-content" style="display: none;">
                            <!-- Product List View -->
                            <div id="product-list-view">
                                <div class="filters-container">
                                    <div class="filter-group">
                                        <span class="filter-label">Brand:</span>
                                        <select class="filter-select" id="brandFilter">
                                            <option value="all">All Brands</option>
                                            <option value="BMW">BMW</option>
                                            <option value="AUDI">AUDI</option>
                                            <option value="ALFA ROMEO">ALFA ROMEO</option>
                                        </select>
                                    </div>
                                    <div class="search-box">
                                        <span class="search-icon">🔍</span>
                                        <input type="text" class="search-input" id="searchInput" placeholder="Search products...">
                                    </div>
                                </div>

                                <div class="data-table-container">
                                    <table class="data-table" id="products-table">
                                        <thead>
                                            <tr>
                                                <th>Product</th>
                                                <th>Brand</th>
                                                <th>Variants & Pricing</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="products-table-body">
                                            <tr>
                                                <td colspan="4">
                                                    <div class="loading">
                                                        <div class="loading-spinner"></div>
                                                        <span>Loading products...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="table-footer">
                                    <div></div>
                                    <div class="pagination" id="products-pagination">
                                        <span class="page-info" id="products-page-info">Showing 1-10 of 0 products</span>
                                        <button class="prev-page-button" id="products-prev">◀</button>
                                        <div id="products-page-buttons"></div>
                                        <button class="next-page-button" id="products-next">▶</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Product Detail View -->
                            <div id="product-detail-view" style="display: none;">
                                <div class="product-detail-header">
                                    <div style="display: flex; align-items: center; gap: 16px;">
                                        <button class="back-button" onclick="showProductList()">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="m12 19-7-7 7-7"/>
                                                <path d="m19 12H5"/>
                                            </svg>
                                            Back to Products
                                        </button>
                                        <h2 id="product-detail-title">Product Details</h2>
                                    </div>
                                    <button class="action-button edit" id="edit-product-btn" onclick="editCurrentProduct()" style="display: none;">
                                        ✏️ Edit Product
                                    </button>
                                </div>

                                <div class="product-detail-content">
                                    <div class="product-info-section">
                                        <h3>Product Information</h3>
                                        <div id="product-basic-info"></div>
                                    </div>

                                    <div class="product-variants-section">
                                        <div class="section-header">
                                            <h3>Product Variants & SKU Components</h3>
                                            <button class="action-button add" onclick="showAddVariantModal()">
                                                Add New Variant
                                            </button>
                                        </div>
                                        <div class="variants-grid" id="product-variants-grid"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Components Tab -->
                        <div id="components-tab" class="tab-content">
                            <div class="component-linking-info">
                                <h4>Component Stock Management</h4>
                                <p>Manage component inventory. Stock and pricing here affect all related product variants automatically.</p>
                            </div>

                            <div class="filters-container">
                                <div class="filter-group">
                                    <span class="filter-label">Component Type:</span>
                                    <select class="filter-select" id="componentTypeFilter">
                                        <option value="all">All Types</option>
                                        <option value="socket">Socket/Canbus</option>
                                        <option value="casing">Casing</option>
                                        <option value="accessory">Accessory</option>
                                    </select>
                                </div>
                                <div class="search-box">
                                    <span class="search-icon">🔍</span>
                                    <input type="text" class="search-input" id="componentSearchInput" placeholder="Search components...">
                                </div>
                            </div>

                            <div class="data-table-container">
                                <table class="data-table" id="components-table">
                                    <thead>
                                        <tr>
                                            <th>Component SKU</th>
                                            <th>Type</th>
                                            <th>Current Stock</th>
                                            <th>Normal Price</th>
                                            <th>Wholesale Price</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="components-table-body">
                                        <tr>
                                            <td colspan="6">
                                                <div class="loading">
                                                    <div class="loading-spinner"></div>
                                                    <span>Loading components...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Relationships Tab -->
                        <div id="relationships-tab" class="tab-content" style="display: none;">
                            <div class="component-linking-info">
                                <h4>Product-Component Mapping</h4>
                                <p>View which components are used in each product variant and their relationships.</p>
                            </div>

                            <div class="filters-container">
                                <div class="filter-group">
                                    <span class="filter-label">Brand:</span>
                                    <select class="filter-select" id="relationshipBrandFilter">
                                        <option value="all">All Brands</option>
                                        <option value="BMW">BMW</option>
                                        <option value="AUDI">AUDI</option>
                                        <option value="ALFA ROMEO">ALFA ROMEO</option>
                                    </select>
                                </div>
                                <div class="search-box">
                                    <span class="search-icon">🔍</span>
                                    <input type="text" class="search-input" id="relationshipSearchInput" placeholder="Search products...">
                                </div>
                            </div>

                            <div class="data-table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Variant</th>
                                            <th>Component SKUs</th>
                                            <th>Calculated Stock</th>
                                            <th>Calculated Price</th>
                                        </tr>
                                    </thead>
                                    <tbody id="relationships-table-body">
                                        <tr>
                                            <td colspan="5">
                                                <div class="loading">
                                                    <div class="loading-spinner"></div>
                                                    <span>Loading relationships...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header-enhanced">
                <h2 style="color: var(--primary-600); display: flex; align-items: center; gap: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14,2 14,8 20,8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>
                    Create New Product
                </h2>
                <span class="close" id="closeAddModal" style="font-size: 28px; color: var(--neutral-400); cursor: pointer; transition: color 0.3s;">&times;</span>
            </div>
            
            <form id="addProductForm" style="padding: 0 32px 32px 32px;">
                <!-- Workflow Info -->
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 12px; padding: 20px; margin-bottom: 24px; border-left: 4px solid var(--primary-500);">
                    <h4 style="color: var(--primary-600); margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 6v6l4 2"></path>
                        </svg>
                        Smart Component Linking
                    </h4>
                    <p style="margin: 0; color: var(--neutral-700); font-size: 14px; line-height: 1.5;">
                        Products are automatically created with variants that link to existing components. Ensure you have added the required components first!
                    </p>
                </div>

                <!-- Product Basic Info -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="productBrand">Brand *</label>
                        <select class="form-control" id="productBrand" required>
                            <option value="">Select Brand</option>
                            <option value="BMW">BMW</option>
                            <option value="AUDI">AUDI</option>
                            <option value="ALFA ROMEO">ALFA ROMEO</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productModel">Model *</label>
                        <input type="text" class="form-control" id="productModel" placeholder="e.g., X3, A4, 159" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="productYear">Year *</label>
                        <input type="text" class="form-control" id="productYear" placeholder="e.g., 2008-2012" required>
                    </div>
                    <div class="form-group">
                        <label for="productScreenSize">Screen Size *</label>
                        <select class="form-control" id="productScreenSize" required>
                            <option value="">Select Screen Size</option>
                            <option value="9 inch">9 inch</option>
                            <option value="10 inch">10 inch</option>
                            <option value="12.5 inch">12.5 inch</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="productName">Product Name *</label>
                    <input type="text" class="form-control" id="productName" placeholder="Will be auto-generated" required readonly style="background: #f5f5f5;">
                </div>

                <div class="form-group">
                    <label for="productDescription">Description</label>
                    <textarea class="form-control" id="productDescription" rows="3" placeholder="Product description..."></textarea>
                </div>

                <!-- Component Selection Section -->
                <div style="border: 2px solid var(--neutral-200); border-radius: 12px; padding: 20px; margin: 24px 0; background: #fafafa;">
                    <h4 style="color: var(--neutral-700); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                        Select Components for Product Variants
                    </h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="casingComponent">Casing Component *</label>
                            <select class="form-control" id="casingComponent" required>
                                <option value="">Select casing component...</option>
                            </select>
                            <small style="color: var(--neutral-600);">Will be used for "Casing Only" variant</small>
                        </div>
                        <div class="form-group">
                            <label for="socketComponent">Socket/Canbus Component *</label>
                            <select class="form-control" id="socketComponent" required>
                                <option value="">Select socket component...</option>
                            </select>
                            <small style="color: var(--neutral-600);">Will be used for "Socket Only" variant</small>
                        </div>
                    </div>
                    
                    <div id="componentPreview" style="margin-top: 16px; padding: 16px; background: white; border-radius: 8px; border: 1px solid var(--neutral-200); display: none;">
                        <h5 style="margin: 0 0 12px 0; color: var(--neutral-700);">Selected Components Preview:</h5>
                        <div id="previewContent"></div>
                    </div>
                </div>

                <!-- Image Upload -->
                <div class="form-group">
                    <label for="productImage">Product Image</label>
                    <div class="image-upload-container">
                        <input type="file" class="form-control" id="productImage" accept="image/*" onchange="previewAddImage(this)">
                        <div class="image-preview" id="addImagePreview" style="display: none;">
                            <img id="addPreviewImg" style="max-width: 200px; max-height: 150px; border-radius: 8px; margin-top: 10px;">
                            <button type="button" class="remove-image-btn" onclick="removeAddImage()" title="Remove image">✕</button>
                        </div>
                        <div class="upload-placeholder" id="addUploadPlaceholder">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21,15 16,10 5,21"/>
                            </svg>
                            <p>Click to upload product image</p>
                            <small>PNG, JPG up to 5MB</small>
                        </div>
                    </div>
                    <input type="hidden" id="productImageUrl">
                </div>

                <!-- Form Footer -->
                <div class="form-group" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--neutral-200); display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="button outline" id="cancelAddBtn" style="min-width: 120px;">Cancel</button>
                    <button type="submit" class="button primary" style="min-width: 160px; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3); color: white; font-weight: 600; display: flex; align-items: center; justify-content: center;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14,2 14,8 20,8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                        <span>Create Product</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header-enhanced">
                <h2 style="color: var(--primary-600); display: flex; align-items: center; gap: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Edit Product Details
                </h2>
                <span class="close" id="closeEditModal" style="font-size: 28px; color: var(--neutral-400); cursor: pointer; transition: color 0.3s;">&times;</span>
            </div>
            
            <form id="editProductForm" style="padding: 0 32px 32px 32px;">
                <input type="hidden" id="editProductId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editProductProductId">Product ID</label>
                        <input type="text" class="form-control" id="editProductProductId" readonly>
                    </div>
                    <div class="form-group">
                        <label for="editProductBrand">Brand *</label>
                        <select class="form-control" id="editProductBrand" required>
                            <option value="">Select Brand</option>
                            <option value="BMW">BMW</option>
                            <option value="AUDI">AUDI</option>
                            <option value="ALFA ROMEO">ALFA ROMEO</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editProductModel">Model *</label>
                    <input type="text" class="form-control" id="editProductModel" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editProductYear">Year *</label>
                        <input type="text" class="form-control" id="editProductYear" required>
                    </div>
                    <div class="form-group">
                        <label for="editProductScreenSize">Screen Size *</label>
                        <select class="form-control" id="editProductScreenSize" required>
                            <option value="">Select Screen Size</option>
                            <option value="9 inch">9 inch</option>
                            <option value="10 inch">10 inch</option>
                            <option value="12.5 inch">12.5 inch</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editProductName">Product Name *</label>
                    <input type="text" class="form-control" id="editProductName" required>
                </div>

                <div class="form-group">
                    <label for="editProductCategory">Category *</label>
                    <select class="form-control" id="editProductCategory" required>
                        <option value="">Select Category</option>
                        <option value="9/10 inch casing">9/10 inch casing</option>
                        <option value="12.5 inch casing">12.5 inch casing</option>
                        <option value="Android navigation">Android navigation</option>
                        <option value="CarPlay system">CarPlay system</option>
                        <option value="Complete package">Complete package</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editProductDescription">Description</label>
                    <textarea class="form-control" id="editProductDescription"></textarea>
                </div>

                <div class="form-group">
                    <label for="editProductImage">Product Image</label>
                    <div class="image-upload-container">
                        <input type="file" class="form-control" id="editProductImage" accept="image/*" onchange="previewEditImage(this)">
                        <div class="image-preview" id="editImagePreview" style="display: none;">
                            <img id="editPreviewImg" style="max-width: 200px; max-height: 150px; border-radius: 8px; margin-top: 10px;">
                            <button type="button" class="remove-image-btn" onclick="removeEditImage()" title="Remove image">✕</button>
                        </div>
                        <div class="upload-placeholder" id="editUploadPlaceholder">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21,15 16,10 5,21"/>
                            </svg>
                            <p>Click to upload product image</p>
                            <small>PNG, JPG up to 5MB</small>
                        </div>
                    </div>
                    <input type="hidden" id="editProductImageUrl">
                </div>

                <div class="form-group" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--neutral-200); display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="button outline" id="cancelEditBtn" style="min-width: 120px;">Cancel</button>
                    <button type="submit" class="button primary" style="min-width: 140px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); color: white; font-weight: 600; display: flex; align-items: center; justify-content: center;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                        </svg>
                        <span>Update Product</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Component Modal -->
    <div id="addComponentModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header-enhanced">
                <h2 style="color: var(--primary-600); display: flex; align-items: center; gap: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                        <line x1="8" y1="21" x2="16" y2="21"></line>
                        <line x1="12" y1="17" x2="12" y2="21"></line>
                    </svg>
                    Add New Component
                </h2>
                <span class="close" id="closeComponentModal" style="font-size: 28px; color: var(--neutral-400); cursor: pointer; transition: color 0.3s;">&times;</span>
            </div>
            
            <form id="addComponentForm" style="padding: 0 32px 32px 32px;">
                <div class="form-row">
                    <div class="form-group">
                        <label for="componentSku">Component SKU *</label>
                        <input type="text" class="form-control" id="componentSku" placeholder="e.g., BM-999N, CB-999#" required>
                    </div>
                    <div class="form-group">
                        <label for="componentType">Type *</label>
                        <select class="form-control" id="componentType" required>
                            <option value="">Select Type</option>
                            <option value="casing">Casing</option>
                            <option value="socket">Socket</option>
                            <option value="canbus">Canbus</option>
                            <option value="accessory">Accessory</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="componentName">Component Name *</label>
                    <input type="text" class="form-control" id="componentName" placeholder="e.g., BMW X5 Android Casing" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="componentStock">Initial Stock *</label>
                        <input type="number" class="form-control" id="componentStock" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="componentThreshold">Low Stock Threshold</label>
                        <input type="number" class="form-control" id="componentThreshold" min="0" value="10">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="componentRetailPrice">Normal Price (RM)</label>
                        <input type="number" step="0.01" class="form-control" id="componentRetailPrice">
                    </div>
                    <div class="form-group">
                        <label for="componentWholesalePrice">Wholesale Price (RM)</label>
                        <input type="number" step="0.01" class="form-control" id="componentWholesalePrice">
                    </div>
                </div>

                <div class="form-group" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--neutral-200); display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="button outline" id="cancelComponentBtn" style="min-width: 120px;">Cancel</button>
                    <button type="submit" class="button primary" style="min-width: 140px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); color: white; font-weight: 600; display: flex; align-items: center; justify-content: center;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                        <span>Add Component</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Component Modal -->
    <div id="editComponentModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header-enhanced">
                <h2 style="color: var(--primary-600); display: flex; align-items: center; gap: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                        <line x1="8" y1="21" x2="16" y2="21"></line>
                        <line x1="12" y1="17" x2="12" y2="21"></line>
                    </svg>
                    Edit Component Details
                </h2>
                <span class="close" id="closeEditComponentModal" style="font-size: 28px; color: var(--neutral-400); cursor: pointer; transition: color 0.3s;">&times;</span>
            </div>
            
            <form id="editComponentForm" style="padding: 0 32px 32px 32px;">
                <input type="hidden" id="editComponentId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editComponentSku">Component SKU</label>
                        <input type="text" class="form-control" id="editComponentSku" readonly>
                    </div>
                    <div class="form-group">
                        <label for="editComponentType">Type *</label>
                        <select class="form-control" id="editComponentType" required>
                            <option value="">Select Type</option>
                            <option value="casing">Casing</option>
                            <option value="socket">Socket</option>
                            <option value="canbus">Canbus</option>
                            <option value="accessory">Accessory</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editComponentName">Component Name *</label>
                    <input type="text" class="form-control" id="editComponentName" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editComponentStock">Current Stock *</label>
                        <input type="number" class="form-control" id="editComponentStock" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="editComponentThreshold">Low Stock Threshold</label>
                        <input type="number" class="form-control" id="editComponentThreshold" min="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editComponentNormalPrice">Normal Price (RM)</label>
                        <input type="number" step="0.01" class="form-control" id="editComponentNormalPrice">
                    </div>
                    <div class="form-group">
                        <label for="editComponentWholesalePrice">Wholesale Price (RM)</label>
                        <input type="number" step="0.01" class="form-control" id="editComponentWholesalePrice">
                    </div>
                </div>


                <div class="form-group" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--neutral-200); display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="button outline" id="cancelEditComponentBtn" style="min-width: 120px;">Cancel</button>
                    <button type="submit" class="button primary" style="min-width: 140px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); color: white; font-weight: 600; display: flex; align-items: center; justify-content: center;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                        <span>Update Component</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://bbwimjvqpyxwhovihtfm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJid2ltanZxcHl4d2hvdmlodGZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MjAwMDksImV4cCI6MjA2MDk5NjAwOX0._D3wackPNKg-IbiswH7M-3wqeQRP6ujMmcJ9bb7_1z0';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global variables (New Clean Schema)
        let allBrands = [];
        let allProducts = [];
        let allComponents = [];
        let allVariants = [];
        let allRelationships = [];
        let currentTab = 'components';

        // Initialize page
        async function initializePage() {
            try {
                // Check authentication
                const user = await checkAuth();
                if (!user) return;

                // Setup UI
                setupEventListeners();
                
                // Load all data
                await loadAllData();
                
                // Update dashboard
                updateDashboard();
                
                // Display initial tab
                displayCurrentTab();

            } catch (error) {
                console.error('Error initializing page:', error);
                alert('Error loading page. Please refresh and try again.');
            }
        }

        // Check authentication
        async function checkAuth() {
            const userStr = localStorage.getItem('currentUser');
            if (userStr) {
                const user = JSON.parse(userStr);
                updateUserInterface(user);
                return user;
            } else {
                window.location.href = 'admin-login.html';
                return null;
            }
        }

        // Update user interface
        function updateUserInterface(user) {
            if (user.first_name && user.last_name) {
                const initials = user.first_name.charAt(0) + user.last_name.charAt(0);
                document.getElementById('userAvatar').textContent = initials;
                document.getElementById('userName').textContent = `${user.first_name} ${user.last_name}`;
                document.getElementById('userFullName').textContent = `${user.first_name} ${user.last_name}`;
                document.getElementById('userStaffId').textContent = `Staff ID: ${user.staff_id || 'N/A'}`;
            }
        }

        // Load all data (New Clean Schema)
        async function loadAllData() {
            try {
                // Load brands
                const { data: brands, error: brandsError } = await supabase
                    .from('brands')
                    .select('*')
                    .order('name');
                if (brandsError) throw brandsError;
                allBrands = brands || [];

                // Load products with brand relationships
                const { data: products, error: productsError } = await supabase
                    .from('products')
                    .select(`
                        *,
                        brands(id, name, code)
                    `)
                    .order('name');

                if (productsError) throw productsError;
                allProducts = products || [];

                // Load product variants (no stock fields in new schema)
                const { data: variants, error: variantsError } = await supabase
                    .from('product_variants')
                    .select('*')
                    .order('variant_name');

                if (variantsError) throw variantsError;
                allVariants = variants || [];

                // Load components (single source of truth for stock)
                const { data: components, error: componentsError } = await supabase
                    .from('components')
                    .select(`
                        *,
                        brands(id, name, code)
                    `)
                    .order('sku');

                if (componentsError) throw componentsError;
                allComponents = components || [];

                // Load variant-component relationships
                const { data: relationships, error: relationshipsError } = await supabase
                    .from('variant_components')
                    .select(`
                        *,
                        components(
                            id,
                            sku,
                            name,
                            type,
                            available_stock,
                            current_stock,
                            reserved_stock,
                            retail_price,
                            wholesale_price,
                            brands(name, code)
                        ),
                        product_variants(
                            id,
                            variant_name,
                            variant_type,
                            products(
                                id,
                                name,
                                product_id,
                                brands(name, code)
                            )
                        )
                    `);

                if (relationshipsError) throw relationshipsError;
                allRelationships = relationships || [];

                console.log('Data loaded (Clean Schema):', {
                    brands: allBrands.length,
                    products: allProducts.length,
                    variants: allVariants.length,
                    components: allComponents.length,
                    relationships: allRelationships.length
                });

            } catch (error) {
                console.error('Error loading data:', error);
                throw error;
            }
        }

        // Update dashboard statistics
        function updateDashboard() {
            // Total products
            document.getElementById('totalProducts').textContent = allProducts.length;
            
            // Total components (excluding combined ones with '+')
            const individualComponents = allComponents.filter(c => !(c.sku || '').includes('+'));
            document.getElementById('totalComponents').textContent = individualComponents.length;
            
            // Low stock alerts (components with available_stock <= 10)
            const lowStockComponents = individualComponents.filter(c => (c.available_stock || 0) <= 10);
            document.getElementById('lowStockAlerts').textContent = lowStockComponents.length;
            
            // Stock value (total value of all individual components)
            const stockValue = individualComponents.reduce((total, component) => {
                return total + ((component.available_stock || 0) * (component.cost_price || 0));
            }, 0);
            document.getElementById('stockValue').textContent = `RM ${stockValue.toFixed(2)}`;

        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    if (tabName) {
                        switchTab(tabName);
                    }
                });
            });

            // User dropdown
            document.getElementById('userAvatar').addEventListener('click', toggleDropdown);
            document.getElementById('logoutButton').addEventListener('click', logout);

            // Modal buttons
            document.getElementById('addProductBtn').addEventListener('click', openAddProductModal);
            document.getElementById('addComponentBtn').addEventListener('click', openAddComponentModal);
            
            // Add Product Modal
            document.getElementById('closeAddModal').addEventListener('click', closeAddProductModal);
            document.getElementById('cancelAddBtn').addEventListener('click', closeAddProductModal);
            
            // Edit Product Modal
            document.getElementById('closeEditModal').addEventListener('click', closeEditProductModal);
            document.getElementById('cancelEditBtn').addEventListener('click', closeEditProductModal);
            
            // Add Component Modal
            document.getElementById('closeComponentModal').addEventListener('click', closeAddComponentModal);
            document.getElementById('cancelComponentBtn').addEventListener('click', closeAddComponentModal);
            
            // Edit Component Modal
            document.getElementById('closeEditComponentModal').addEventListener('click', closeEditComponentModal);
            document.getElementById('cancelEditComponentBtn').addEventListener('click', closeEditComponentModal);

            // Price Edit Modal
            document.getElementById('closePriceEditModal').addEventListener('click', closePriceEditModal);
            document.getElementById('cancelPriceEditBtn').addEventListener('click', closePriceEditModal);
            document.getElementById('priceEditForm').addEventListener('submit', submitPriceEditForm);

            // Form submissions
            document.getElementById('addProductForm').addEventListener('submit', submitAddProductForm);
            document.getElementById('editProductForm').addEventListener('submit', submitEditProductForm);
            document.getElementById('addComponentForm').addEventListener('submit', submitAddComponentForm);
            document.getElementById('editComponentForm').addEventListener('submit', submitEditComponentForm);

            // Auto-generate product name
            ['productBrand', 'productModel', 'productYear', 'productScreenSize'].forEach(id => {
                document.getElementById(id).addEventListener('input', generateProductName);
            });

            // Search and filters
            document.getElementById('searchInput').addEventListener('input', () => displayCurrentTab());
            document.getElementById('brandFilter').addEventListener('change', () => displayCurrentTab());
            document.getElementById('componentSearchInput').addEventListener('input', () => displayCurrentTab());
            document.getElementById('componentTypeFilter').addEventListener('change', () => displayCurrentTab());
            document.getElementById('relationshipSearchInput').addEventListener('input', () => displayCurrentTab());
            document.getElementById('relationshipBrandFilter').addEventListener('change', () => displayCurrentTab());

            // Export and bulk upload
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('bulkUploadBtn').addEventListener('click', () => {
                alert('Bulk upload functionality would be implemented here. This would allow CSV upload of multiple products.');
            });
        }

        // Switch tabs
        function switchTab(tabName) {
            // Update tab styles
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`${tabName}-tab`).style.display = 'block';

            currentTab = tabName;
            displayCurrentTab();
        }

        // Display current tab content
        function displayCurrentTab() {
            switch(currentTab) {
                case 'components':
                    displayComponents();
                    break;
                case 'relationships':
                    displayRelationships();
                    break;
                case 'products':
                    displayProducts();
                    break;
            }
        }

        // Display products with proper filtering
        function displayProducts() {
            const tableBody = document.getElementById('products-table-body');
            
            // Apply filters - Start with copy of all products
            let filteredProducts = [...allProducts];
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const brandFilter = document.getElementById('brandFilter').value;

            if (searchTerm) {
                filteredProducts = filteredProducts.filter(product => 
                    (product.name || '').toLowerCase().includes(searchTerm) ||
                    (product.product_id || '').toLowerCase().includes(searchTerm) ||
                    (product.model || '').toLowerCase().includes(searchTerm)
                );
            }

            if (brandFilter !== 'all') {
                filteredProducts = filteredProducts.filter(product => 
                    (product.brands?.name || '').includes(brandFilter)
                );
            }

            tableBody.innerHTML = '';

            if (filteredProducts.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px;">
                            No products found matching your criteria.
                        </td>
                    </tr>
                `;
                return;
            }

            filteredProducts.forEach(product => {
                // Get variants for this product
                const productVariants = allVariants.filter(v => v.product_id === product.id);
                
                // Calculate price range from components
                const priceRange = calculateProductPriceRange(product.id);
                let priceDisplay = '';
                if (priceRange.hasPrice) {
                    if (priceRange.minPrice === priceRange.maxPrice) {
                        priceDisplay = `RM ${priceRange.minPrice.toFixed(2)}`;
                    } else {
                        priceDisplay = `RM ${priceRange.minPrice.toFixed(2)} - ${priceRange.maxPrice.toFixed(2)}`;
                    }
                } else {
                    priceDisplay = '<span style="color: var(--warning); font-size: 12px;">No pricing</span>';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div><strong>${product.name || 'Unnamed Product'}</strong></div>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">
                            ID: ${product.product_id || 'N/A'}
                        </div>
                        <div style="font-size: 11px; color: var(--text-light); margin-top: 2px;">
                            Model: ${product.model || 'N/A'} | Year: ${product.year || 'N/A'}
                        </div>
                    </td>
                    <td>
                        <span class="component-sku">${product.brands?.name || 'Unknown'}</span>
                    </td>
                    <td>
                        <div style="font-weight: 500;">${productVariants.length} variant${productVariants.length !== 1 ? 's' : ''}</div>
                        <div style="font-size: 12px; color: var(--primary-600); font-weight: 600; margin-top: 4px;">
                            ${priceDisplay}
                        </div>
                    </td>
                    <td>
                        <button class="action-button edit" onclick="editProduct('${product.id}')" title="Edit Product" style="margin-right: 8px;">
                            ✏️ Edit
                        </button>
                        <button class="action-button view" onclick="showProductDetail('${product.id}')">
                            View Details
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Update page info
            document.getElementById('products-page-info').textContent = 
                `Showing ${filteredProducts.length} of ${allProducts.length} products`;
        }

        // Display components with stock and pricing management
        function displayComponents() {
            const tableBody = document.getElementById('components-table-body');
            
            // Filter out combined components (those with '+' in SKU) first
            let filteredComponents = allComponents.filter(component => {
                const sku = component.sku || '';
                return !sku.includes('+');
            });
            
            const searchTerm = document.getElementById('componentSearchInput').value.toLowerCase();
            const typeFilter = document.getElementById('componentTypeFilter').value;

            if (searchTerm) {
                filteredComponents = filteredComponents.filter(component => 
                    (component.sku || '').toLowerCase().includes(searchTerm) ||
                    (component.name || '').toLowerCase().includes(searchTerm)
                );
            }

            if (typeFilter !== 'all') {
                filteredComponents = filteredComponents.filter(component => 
                    (component.type || '').includes(typeFilter)
                );
            }

            tableBody.innerHTML = '';

            if (filteredComponents.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            No components found matching your criteria.
                        </td>
                    </tr>
                `;
                return;
            }

            filteredComponents.forEach(component => {
                const currentStock = component.current_stock || 0;
                const availableStock = component.available_stock || 0;

                let stockClass = 'high';
                if (availableStock === 0) stockClass = 'low';
                else if (availableStock <= 10) stockClass = 'medium';

                // Find relationships that use this component
                const componentRelationships = allRelationships.filter(r => r.component_id === component.id);
                
                let displayRetailPrice = 0;
                let displayWholesalePrice = 0;
                let priceNote = 'No pricing set';

                // Always use component's own pricing (components are the source of truth for prices)
                displayRetailPrice = component.retail_price || 0;
                displayWholesalePrice = component.wholesale_price || 0;
                
                if (componentRelationships.length > 0) {
                    // Get variant IDs to show how many variants use this component
                    const variantIds = [...new Set(componentRelationships.map(r => r.variant_id))].filter(id => id);
                    priceNote = variantIds.length > 1 ? `Used in ${variantIds.length} variants` : 'Used in 1 variant';
                } else {
                    priceNote = 'Not used in any variants';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div><strong>${component.sku}</strong></div>
                        <div style="font-size: 12px; color: var(--text-light);">
                            ${component.name || 'Unnamed Component'}
                        </div>
                    </td>
                    <td>
                        <span class="component-sku">${component.type || 'Unknown'}</span>
                    </td>
                    <td>
                        <div><strong>${availableStock}</strong> units</div>
                        <div style="font-size: 11px; color: var(--text-light);">
                            <span class="stock-value ${stockClass}">
                                ${stockClass === 'low' ? 'Out of Stock' : stockClass === 'medium' ? 'Low Stock' : 'In Stock'}
                            </span>
                        </div>
                    </td>
                    <td>
                        <div><strong>RM ${displayRetailPrice.toFixed(2)}</strong></div>
                        <div style="font-size: 11px; color: var(--text-light);">${priceNote}</div>
                    </td>
                    <td>
                        <div><strong>RM ${displayWholesalePrice.toFixed(2)}</strong></div>
                        <div style="font-size: 11px; color: var(--text-light);">${priceNote}</div>
                    </td>
                    <td>
                        <button class="action-button edit" onclick="editComponent('${component.id}')" title="Edit Component" style="margin-right: 8px;">
                            ✏️ Edit
                        </button>
                        <button class="action-button add" onclick="addComponentStock('${component.id}')" title="Add Stock">
                            + Stock
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Display relationships showing product-component mappings
        function displayRelationships() {
            const tableBody = document.getElementById('relationships-table-body');
            
            // Get search and filter values
            const searchTerm = document.getElementById('relationshipSearchInput').value.toLowerCase();
            const brandFilter = document.getElementById('relationshipBrandFilter').value;
            
            // Group relationships by variant
            const variantGroups = {};
            
            allRelationships.forEach(rel => {
                if (!rel.variant_id || !rel.product_variants?.products) return;
                
                const variantId = rel.variant_id;
                if (!variantGroups[variantId]) {
                    variantGroups[variantId] = {
                        variant: rel.product_variants,
                        product: rel.product_variants.products,
                        components: []
                    };
                }
                
                if (rel.components) {
                    variantGroups[variantId].components.push(rel.components);
                }
            });

            // Convert to array and apply filters with proper sorting
            let filteredGroups = Object.values(variantGroups)
                .sort((a, b) => {
                    // First sort by product name, then by variant display_order
                    if (a.product.name !== b.product.name) {
                        return a.product.name.localeCompare(b.product.name);
                    }
                    return (a.variant.display_order || 999) - (b.variant.display_order || 999);
                });
            
            if (searchTerm) {
                filteredGroups = filteredGroups.filter(group => 
                    (group.product.name || '').toLowerCase().includes(searchTerm) ||
                    (group.variant.variant_name || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (brandFilter !== 'all') {
                filteredGroups = filteredGroups.filter(group => 
                    (group.product.brands?.name || '').includes(brandFilter)
                );
            }

            tableBody.innerHTML = '';

            if (filteredGroups.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            No relationships found matching your criteria.
                        </td>
                    </tr>
                `;
                return;
            }

            filteredGroups.forEach(group => {
                // Calculate stock (minimum of all component stocks)
                let calculatedStock = 999999;
                group.components.forEach(component => {
                    const componentStock = component.available_stock || 0;
                    if (componentStock < calculatedStock) {
                        calculatedStock = componentStock;
                    }
                });
                if (calculatedStock === 999999) calculatedStock = 0;

                // Calculate prices (sum of all component prices)
                let calculatedRetailPrice = 0;
                let calculatedWholesalePrice = 0;
                group.components.forEach(component => {
                    const retailPrice = component.retail_price || component.suggested_retail_price || 0;
                    const wholesalePrice = component.wholesale_price || (retailPrice * 0.8) || 0;
                    calculatedRetailPrice += retailPrice;
                    calculatedWholesalePrice += wholesalePrice;
                });

                const stockClass = calculatedStock === 0 ? 'low' : calculatedStock <= 10 ? 'medium' : 'high';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div><strong>${group.product.name || 'Unnamed Product'}</strong></div>
                        <div style="font-size: 11px; color: var(--text-light);">
                            ${group.product.brands?.name || 'Unknown Brand'}
                        </div>
                    </td>
                    <td>
                        <div><strong>${group.variant.variant_name || 'Unnamed Variant'}</strong></div>
                        <div style="font-size: 11px; color: var(--text-light);">
                            Components: ${group.components.map(comp => comp.sku).join(', ') || 'N/A'}
                        </div>
                    </td>
                    <td>
                        ${group.components.map(comp => 
                            `<span class="component-sku" style="margin-right: 4px; margin-bottom: 4px; display: inline-block;">
                                ${comp.sku}
                            </span>`
                        ).join('')}
                    </td>
                    <td>
                        <div><strong>${calculatedStock}</strong> units</div>
                        <div style="font-size: 11px; color: var(--text-light);">
                            <span class="stock-value ${stockClass}">
                                ${stockClass === 'low' ? 'Out of Stock' : stockClass === 'medium' ? 'Low Stock' : 'In Stock'}
                            </span>
                        </div>
                    </td>
                    <td>
                        <div><strong>RM ${calculatedRetailPrice.toFixed(2)}</strong> / <strong>RM ${calculatedWholesalePrice.toFixed(2)}</strong></div>
                        <div style="font-size: 11px; color: var(--text-light);">Normal / Wholesale</div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Add stock to component (not edit - ADD to existing)
        async function addComponentStock(componentId) {
            try {
                const component = allComponents.find(c => c.id === componentId);
                if (!component) {
                    alert('Component not found');
                    return;
                }

                const addQuantity = prompt(`Add stock to ${component.sku}\nCurrent stock: ${component.available_stock || 0} units\nQuantity to ADD:`, '0');
                
                if (addQuantity !== null && !isNaN(addQuantity) && parseInt(addQuantity) > 0) {
                    const currentStock = component.current_stock || 0;
                    const newCurrentStock = currentStock + parseInt(addQuantity);

                    // Update component stock in database - don't update available_stock as it's generated
                    const { error } = await supabase
                        .from('components')
                        .update({
                            current_stock: newCurrentStock
                        })
                        .eq('id', componentId);

                    if (error) throw error;

                    // Update related variant stocks based on component availability
                    await updateRelatedVariantStocks(componentId);

                    // Reload data and refresh display
                    await loadAllData();
                    updateDashboard();
                    displayCurrentTab();
                    
                    // Get updated component data to show correct available stock
                    const updatedComponent = allComponents.find(c => c.id === componentId);
                    const newAvailableStock = updatedComponent?.available_stock || newCurrentStock;
                    
                    alert(`✅ Added ${addQuantity} units to ${component.sku}. New available stock: ${newAvailableStock} units (Total: ${newCurrentStock})`);
                }
                
            } catch (error) {
                console.error('Error adding component stock:', error);
                alert('❌ Error adding stock: ' + error.message);
            }
        }

        // Global variable to store current editing component data
        let currentEditingComponent = null;

        // Open price edit modal
        function editComponentPricing(componentId) {
            const component = allComponents.find(c => c.id === componentId);
            if (!component) {
                alert('Component not found');
                return;
            }

            // Find relationship records that use this component
            const relatedRelationships = allRelationships.filter(r => r.component_id === componentId);

            if (relatedRelationships.length === 0) {
                alert(`No product variants use component ${component.sku}. Please check component relationships.`);
                return;
            }

            // Get unique variant IDs from relationships
            const variantIds = [...new Set(relatedRelationships.map(r => r.variant_id))].filter(id => id);
            
            if (variantIds.length === 0) {
                alert(`No valid variant IDs found for component ${component.sku}. Please check data integrity.`);
                return;
            }

            // Find the actual variants from allVariants array
            const relatedVariants = allVariants.filter(v => variantIds.includes(v.id));

            if (relatedVariants.length === 0) {
                alert(`No variant data found for component ${component.sku}. Please reload the page.`);
                return;
            }

            // Store current editing data
            currentEditingComponent = {
                component: component,
                variants: relatedVariants
            };

            // Use the first variant's price as the base price
            const baseVariant = relatedVariants[0];
            const currentRetailPrice = baseVariant.retail_price || 0;
            const currentWholesalePrice = baseVariant.wholesale_price || 0;

            // Populate modal
            document.getElementById('editPriceComponentInfo').textContent = `${component.sku} - ${component.name || 'Unnamed Component'}`;
            
            const variantInfo = relatedVariants.length === 1 ? 
                `Used in: ${baseVariant.variant_name}` :
                `Used in ${relatedVariants.length} variants - will update all variants`;
            document.getElementById('editPriceVariantInfo').textContent = variantInfo;
            
            document.getElementById('editNormalPrice').value = currentRetailPrice.toFixed(2);
            document.getElementById('editWholesalePrice').value = currentWholesalePrice.toFixed(2);

            // Show modal
            document.getElementById('priceEditModal').style.display = 'block';
        }

        // Close price edit modal
        function closePriceEditModal() {
            document.getElementById('priceEditModal').style.display = 'none';
            currentEditingComponent = null;
            document.getElementById('priceEditForm').reset();
        }

        // Submit price edit form
        async function submitPriceEditForm(e) {
            e.preventDefault();
            
            if (!currentEditingComponent) {
                alert('No component data found');
                return;
            }

            try {
                const newRetailPrice = parseFloat(document.getElementById('editNormalPrice').value);
                const newWholesalePrice = parseFloat(document.getElementById('editWholesalePrice').value);

                if (newRetailPrice < 0 || newWholesalePrice < 0) {
                    alert('Prices cannot be negative');
                    return;
                }

                // Update all related variant prices
                const updatePromises = currentEditingComponent.variants.map(variant => {
                    return supabase
                        .from('product_variants')
                        .update({
                            retail_price: newRetailPrice,
                            wholesale_price: newWholesalePrice
                        })
                        .eq('id', variant.id);
                });

                const results = await Promise.all(updatePromises);
                
                // Check for errors
                const errors = results.filter(r => r.error);
                if (errors.length > 0) {
                    console.error('Update errors:', errors);
                    throw new Error(`Failed to update ${errors.length} variants`);
                }

                // Store info for success message before closing modal
                const componentSku = currentEditingComponent.component.sku;
                const variantCount = currentEditingComponent.variants.length;

                // Close modal and refresh data
                closePriceEditModal();
                await loadAllData();
                updateDashboard();
                displayCurrentTab();
                
                alert(`✅ Updated pricing for ${componentSku} across ${variantCount} variant(s)!`);
                
            } catch (error) {
                console.error('Error updating prices:', error);
                alert('❌ Error updating prices: ' + error.message);
            }
        }

        // Update variant stocks based on component availability
        async function updateRelatedVariantStocks(componentId) {
            try {
                // Get all variants that use this component
                const relatedRelationships = allRelationships.filter(r => r.component_id === componentId);
                console.log('Updating variant stocks for component:', componentId, relatedRelationships);
                
                for (const relationship of relatedRelationships) {
                    if (relationship.variant_id) {
                        console.log('Calling update_variant_stock for variant:', relationship.variant_id);
                        
                        // Call stored procedure or custom function to recalculate variant stock
                        const { error } = await supabase.rpc('update_variant_stock', { variant_id: relationship.variant_id });
                        
                        if (error) {
                            console.warn(`Failed to update variant stock for ${relationship.variant_id}:`, error.message);
                            // Continue with other variants even if one fails
                        }
                    }
                }
            } catch (error) {
                console.error('Error updating variant stocks:', error);
                // Don't throw error here to prevent blocking the main stock update
            }
        }

        // Note: Variant prices are no longer stored - prices come directly from components

        // Generate product name automatically
        function generateProductName() {
            const brand = document.getElementById('productBrand').value;
            const model = document.getElementById('productModel').value;
            const year = document.getElementById('productYear').value;
            const screenSize = document.getElementById('productScreenSize').value;

            if (brand && model && year) {
                let name = `${brand} ${model} ${year}`;
                if (screenSize) {
                    name += ` ${screenSize}`;
                }
                name += ' Android Navigation System';
                document.getElementById('productName').value = name;
            }
        }

        // Modal functions
        function openAddProductModal() {
            document.getElementById('addProductForm').reset();
            populateComponentDropdowns();
            document.getElementById('addProductModal').style.display = 'block';
        }

        function closeAddProductModal() {
            document.getElementById('addProductModal').style.display = 'none';
        }

        function openAddComponentModal() {
            document.getElementById('addComponentForm').reset();
            document.getElementById('addComponentModal').style.display = 'block';
        }

        function closeAddComponentModal() {
            document.getElementById('addComponentModal').style.display = 'none';
        }

        function closeEditProductModal() {
            document.getElementById('editProductModal').style.display = 'none';
        }

        function closeEditComponentModal() {
            document.getElementById('editComponentModal').style.display = 'none';
        }

        // Calculate variant pricing from linked components
        function calculateVariantPricing(variantId) {
            const variantRelationships = allRelationships.filter(r => r.variant_id === variantId);
            
            let totalRetailPrice = 0;
            let totalWholesalePrice = 0;
            let hasValidComponents = false;

            variantRelationships.forEach(rel => {
                const component = rel.components || allComponents.find(c => c.id === rel.component_id);
                if (component) {
                    const quantity = rel.quantity_needed || 1;
                    totalRetailPrice += (component.retail_price || 0) * quantity;
                    totalWholesalePrice += (component.wholesale_price || 0) * quantity;
                    hasValidComponents = true;
                }
            });

            return {
                retailPrice: totalRetailPrice,
                wholesalePrice: totalWholesalePrice,
                hasComponents: hasValidComponents
            };
        }

        // Calculate product price range from all variants
        function calculateProductPriceRange(productId) {
            const productVariants = allVariants.filter(v => v.product_id === productId);
            
            if (productVariants.length === 0) {
                return { minPrice: 0, maxPrice: 0, hasPrice: false };
            }

            let minPrice = Infinity;
            let maxPrice = 0;
            let hasValidPrice = false;

            productVariants.forEach(variant => {
                const pricing = calculateVariantPricing(variant.id);
                if (pricing.hasComponents && pricing.retailPrice > 0) {
                    minPrice = Math.min(minPrice, pricing.retailPrice);
                    maxPrice = Math.max(maxPrice, pricing.retailPrice);
                    hasValidPrice = true;
                }
            });

            return {
                minPrice: hasValidPrice ? minPrice : 0,
                maxPrice: hasValidPrice ? maxPrice : 0,
                hasPrice: hasValidPrice
            };
        }

        // Populate component dropdowns for add product modal
        function populateComponentDropdowns() {
            const casingSelect = document.getElementById('casingComponent');
            const socketSelect = document.getElementById('socketComponent');
            
            // Clear existing options (keep the default option)
            casingSelect.innerHTML = '<option value="">Select casing component...</option>';
            socketSelect.innerHTML = '<option value="">Select socket component...</option>';
            
            // Filter and populate casing components
            const casingComponents = allComponents.filter(c => c.type === 'casing');
            casingComponents.forEach(component => {
                const option = document.createElement('option');
                option.value = component.id;
                option.textContent = `${component.name} (${component.sku}) - Stock: ${component.current_stock || 0}`;
                option.dataset.price = component.retail_price || 0;
                option.dataset.wholesalePrice = component.wholesale_price || 0;
                casingSelect.appendChild(option);
            });
            
            // Filter and populate socket components
            const socketComponents = allComponents.filter(c => c.type === 'socket');
            socketComponents.forEach(component => {
                const option = document.createElement('option');
                option.value = component.id;
                option.textContent = `${component.name} (${component.sku}) - Stock: ${component.current_stock || 0}`;
                option.dataset.price = component.retail_price || 0;
                option.dataset.wholesalePrice = component.wholesale_price || 0;
                socketSelect.appendChild(option);
            });
            
            // Add event listeners for component selection preview
            casingSelect.addEventListener('change', updateComponentPreview);
            socketSelect.addEventListener('change', updateComponentPreview);
        }
        
        // Update component preview when components are selected
        function updateComponentPreview() {
            const casingSelect = document.getElementById('casingComponent');
            const socketSelect = document.getElementById('socketComponent');
            const previewSection = document.getElementById('componentPreview');
            
            const selectedCasing = casingSelect.value;
            const selectedSocket = socketSelect.value;
            
            if (selectedCasing || selectedSocket) {
                let previewHtml = '<h5 style="color: var(--primary-600); margin-bottom: 16px;">Selected Components:</h5>';
                
                if (selectedCasing) {
                    const casingOption = casingSelect.selectedOptions[0];
                    previewHtml += `
                        <div class="component-preview-item">
                            <strong>Casing:</strong> ${casingOption.textContent}<br>
                            <small>Retail: RM ${casingOption.dataset.price} | Wholesale: RM ${casingOption.dataset.wholesalePrice}</small>
                        </div>
                    `;
                }
                
                if (selectedSocket) {
                    const socketOption = socketSelect.selectedOptions[0];
                    previewHtml += `
                        <div class="component-preview-item">
                            <strong>Socket:</strong> ${socketOption.textContent}<br>
                            <small>Retail: RM ${socketOption.dataset.price} | Wholesale: RM ${socketOption.dataset.wholesalePrice}</small>
                        </div>
                    `;
                }
                
                previewSection.innerHTML = previewHtml;
                previewSection.style.display = 'block';
            } else {
                previewSection.style.display = 'none';
            }
        }

        // Edit Product Function
        async function editProduct(productId) {
            try {
                const product = allProducts.find(p => p.id === productId);
                if (!product) {
                    alert('Product not found');
                    return;
                }

                // Populate edit form
                document.getElementById('editProductId').value = product.id;
                document.getElementById('editProductProductId').value = product.productID || product.product_id || '';
                document.getElementById('editProductBrand').value = product.brand || '';
                document.getElementById('editProductModel').value = product.model || '';
                document.getElementById('editProductYear').value = product.year || product.year_range || '';
                document.getElementById('editProductScreenSize').value = product.screensize || '';
                document.getElementById('editProductName').value = product.name || '';
                document.getElementById('editProductDescription').value = product.description || '';
                document.getElementById('editProductCategory').value = product.category || '';
                
                // Handle existing image
                if (product.image_url) {
                    document.getElementById('editProductImageUrl').value = product.image_url;
                    document.getElementById('editPreviewImg').src = product.image_url;
                    document.getElementById('editImagePreview').style.display = 'block';
                    document.getElementById('editUploadPlaceholder').style.display = 'none';
                } else {
                    document.getElementById('editProductImageUrl').value = '';
                    document.getElementById('editImagePreview').style.display = 'none';
                    document.getElementById('editUploadPlaceholder').style.display = 'block';
                }

                document.getElementById('editProductModal').style.display = 'block';
            } catch (error) {
                console.error('Error opening edit product modal:', error);
                alert('Error loading product data');
            }
        }

        // Edit Component Function
        async function editComponent(componentId) {
            try {
                const component = allComponents.find(c => c.id === componentId);
                if (!component) {
                    alert('Component not found');
                    return;
                }

                // Populate edit form
                document.getElementById('editComponentId').value = component.id;
                document.getElementById('editComponentSku').value = component.sku || '';
                document.getElementById('editComponentName').value = component.name || '';
                document.getElementById('editComponentType').value = component.type || '';
                document.getElementById('editComponentStock').value = component.current_stock || 0;
                document.getElementById('editComponentThreshold').value = component.low_stock_threshold || 10;
                document.getElementById('editComponentNormalPrice').value = component.retail_price || '';
                document.getElementById('editComponentWholesalePrice').value = component.wholesale_price || '';

                document.getElementById('editComponentModal').style.display = 'block';
            } catch (error) {
                console.error('Error opening edit component modal:', error);
                alert('Error loading component data');
            }
        }

        // Submit edit product form
        async function submitEditProductForm(e) {
            e.preventDefault();
            
            try {
                const productId = document.getElementById('editProductId').value;
                const updatedData = {
                    brand: document.getElementById('editProductBrand').value,
                    model: document.getElementById('editProductModel').value,
                    year: document.getElementById('editProductYear').value,
                    screensize: document.getElementById('editProductScreenSize').value,
                    name: document.getElementById('editProductName').value,
                    description: document.getElementById('editProductDescription').value,
                    // category: document.getElementById('editProductCategory').value, // Temporarily disabled until column exists
                    image_url: document.getElementById('editProductImageUrl').value || null
                };

                const { error } = await supabase
                    .from('products')
                    .update(updatedData)
                    .eq('id', productId);

                if (error) throw error;

                closeEditProductModal();
                await loadAllData();
                updateDashboard();
                displayCurrentTab();
                
                alert('✅ Product updated successfully!');
                
            } catch (error) {
                console.error('Error updating product:', error);
                alert('❌ Error updating product: ' + error.message);
            }
        }

        // Submit edit component form
        async function submitEditComponentForm(e) {
            e.preventDefault();
            
            try {
                const componentId = document.getElementById('editComponentId').value;
                const updatedData = {
                    name: document.getElementById('editComponentName').value,
                    type: document.getElementById('editComponentType').value,
                    current_stock: parseInt(document.getElementById('editComponentStock').value),
                    low_stock_threshold: parseInt(document.getElementById('editComponentThreshold').value),
                    retail_price: parseFloat(document.getElementById('editComponentNormalPrice').value) || null,
                    wholesale_price: parseFloat(document.getElementById('editComponentWholesalePrice').value) || null
                };

                // Note: available_stock is calculated automatically by database

                const { error } = await supabase
                    .from('components')
                    .update(updatedData)
                    .eq('id', componentId);

                if (error) throw error;

                // Note: Prices are now fetched directly from components, no need to update variants

                closeEditComponentModal();
                await loadAllData();
                updateDashboard();
                displayCurrentTab();
                
                alert('✅ Component updated successfully!');
                
            } catch (error) {
                console.error('Error updating component:', error);
                alert('❌ Error updating component: ' + error.message);
            }
        }

        // Submit add product form (New component-based approach)
        async function submitAddProductForm(e) {
            e.preventDefault();
            
            try {
                // Validation for basic product info
                const brand = document.getElementById('productBrand').value;
                const model = document.getElementById('productModel').value.trim();
                const year = document.getElementById('productYear').value.trim();
                const name = document.getElementById('productName').value.trim();
                
                // Validation for component selections
                const selectedCasingId = document.getElementById('casingComponent').value;
                const selectedSocketId = document.getElementById('socketComponent').value;

                if (!brand || !model || !year || !name) {
                    alert('❌ Please fill in all required fields (Brand, Model, Year, Name)');
                    return;
                }

                if (!selectedCasingId || !selectedSocketId) {
                    alert('❌ Please select both casing and socket components');
                    return;
                }

                // Get selected components for validation
                const casingComponent = allComponents.find(c => c.id === selectedCasingId);
                const socketComponent = allComponents.find(c => c.id === selectedSocketId);
                
                if (!casingComponent || !socketComponent) {
                    alert('❌ Selected components not found. Please refresh and try again.');
                    return;
                }

                // Check component stock
                if ((casingComponent.current_stock || 0) <= 0) {
                    alert(`❌ Selected casing component "${casingComponent.name}" is out of stock`);
                    return;
                }
                
                if ((socketComponent.current_stock || 0) <= 0) {
                    alert(`❌ Selected socket component "${socketComponent.name}" is out of stock`);
                    return;
                }

                const formData = {
                    brand: brand,
                    model: model,
                    year: year,
                    screensize: document.getElementById('productScreenSize').value,
                    name: name,
                    description: document.getElementById('productDescription').value,
                    category: document.getElementById('productCategory').value,
                    imageUrl: document.getElementById('productImageUrl').value || null,
                    casingComponentId: selectedCasingId,
                    socketComponentId: selectedSocketId,
                    casingComponent: casingComponent,
                    socketComponent: socketComponent
                };

                // Create the product with component-based variants
                await createComponentBasedProduct(formData);
                
                closeAddProductModal();
                await loadAllData();
                updateDashboard();
                displayCurrentTab();
                
                alert('✅ Product created successfully with component linking!');
                
            } catch (error) {
                console.error('Error creating product:', error);
                alert('❌ Error creating product: ' + error.message);
            }
        }

        // Get or create brand
        async function getOrCreateBrand(brandName) {
            // First, try to find existing brand
            const { data: existingBrand } = await supabase
                .from('brands')
                .select('id')
                .eq('name', brandName)
                .single();

            if (existingBrand) {
                return existingBrand.id;
            }

            // Create new brand if it doesn't exist
            const { data: newBrand, error } = await supabase
                .from('brands')
                .insert({ 
                    name: brandName,
                    is_active: true 
                })
                .select('id')
                .single();

            if (error) {
                throw new Error(`Failed to create brand ${brandName}: ${error.message}`);
            }

            return newBrand.id;
        }

        // Create component-based product with selected components
        async function createComponentBasedProduct(formData) {
            // Generate product ID
            const productId = `${formData.brand.toUpperCase()}-${formData.model.toUpperCase()}-${formData.year}`.replace(/\s+/g, '-');
            
            try {
                // 1. Get or create brand
                let brandId = await getOrCreateBrand(formData.brand);
                
                // 2. Create main product
                const { data: product, error: productError } = await supabase
                    .from('products')
                    .insert({
                        product_id: productId,
                        brand: formData.brand,
                        model: formData.model,
                        year: formData.year,
                        screensize: formData.screensize,
                        description: formData.description,
                        category: formData.category,
                        image_url: formData.imageUrl,
                        name: formData.name,
                        brand_id: brandId,
                        is_active: true
                    })
                    .select()
                    .single();

                if (productError) throw new Error('Failed to create product: ' + productError.message);

                // 3. Create variants with selected components
                const variants = [
                    {
                        variant_sku: `${productId}-CASING`,
                        variant_name: 'Android Casing Only',
                        variant_type: 'casing',
                        display_order: 1,
                        available_stock: 0, // Will be updated based on components
                        is_active: true,
                        product_id: product.id
                    },
                    {
                        variant_sku: `${productId}-SOCKET`,
                        variant_name: 'Socket Canbus Only',
                        variant_type: 'socket',
                        display_order: 2,
                        available_stock: 0,
                        is_active: true,
                        product_id: product.id
                    },
                    {
                        variant_sku: `${productId}-PKG`,
                        variant_name: 'Complete Package',
                        variant_type: 'package',
                        display_order: 3,
                        available_stock: 0,
                        is_active: true,
                        product_id: product.id
                    }
                ];

                const { data: createdVariants, error: variantsError } = await supabase
                    .from('product_variants')
                    .insert(variants)
                    .select();

                if (variantsError) throw new Error('Failed to create variants: ' + variantsError.message);

                // 4. Link variants to selected components
                const componentLinks = [
                    // Android Casing Only → Selected casing component
                    {
                        variant_id: createdVariants.find(v => v.variant_name === 'Android Casing Only').id,
                        component_id: formData.casingComponentId,
                        quantity: 1
                    },
                    // Socket Canbus Only → Selected socket component
                    {
                        variant_id: createdVariants.find(v => v.variant_name === 'Socket Canbus Only').id,
                        component_id: formData.socketComponentId,
                        quantity: 1
                    },
                    // Complete Package → Both selected components
                    {
                        variant_id: createdVariants.find(v => v.variant_name === 'Complete Package').id,
                        component_id: formData.casingComponentId,
                        quantity: 1
                    },
                    {
                        variant_id: createdVariants.find(v => v.variant_name === 'Complete Package').id,
                        component_id: formData.socketComponentId,
                        quantity: 1
                    }
                ];

                const { error: linksError } = await supabase
                    .from('variant_components')
                    .insert(componentLinks);

                if (linksError) throw new Error('Failed to link components: ' + linksError.message);

                // 5. Update variant stock based on selected component availability
                for (const variant of createdVariants) {
                    await supabase.rpc('update_variant_stock', { variant_id: variant.id });
                }

                console.log(`✅ Product created successfully with selected components:`);
                console.log(`   - Casing: ${formData.casingComponent.name} (${formData.casingComponent.sku})`);
                console.log(`   - Socket: ${formData.socketComponent.name} (${formData.socketComponent.sku})`);

            } catch (error) {
                console.error('Error in createComponentBasedProduct:', error);
                throw error;
            }
        }

        // Create component if it doesn't exist
        async function createComponentIfNotExists(sku, name, type) {
            const { data: existing } = await supabase
                .from('components')
                .select('id')
                .eq('sku', sku)
                .single();

            if (!existing) {
                const { error } = await supabase
                    .from('components')
                    .insert({
                        sku,
                        name,
                        type,
                        current_stock: 100,
                        reserved_stock: 0,
                        // available_stock is generated automatically (current_stock - reserved_stock)
                        low_stock_threshold: 10,
                        retail_price: 25.00,
                        wholesale_price: 20.00,
                        is_active: true
                    });

                if (error) {
                    console.error('Error creating component:', error);
                    throw new Error(`Failed to create component ${sku}: ${error.message}`);
                }

                console.log(`✅ Created component: ${sku}`);
            }
        }

        // Submit add component form
        async function submitAddComponentForm(e) {
            e.preventDefault();
            
            try {
                // Validation
                const sku = document.getElementById('componentSku').value.trim();
                const name = document.getElementById('componentName').value.trim();
                const type = document.getElementById('componentType').value;
                const stock = document.getElementById('componentStock').value;

                if (!sku || !name || !type) {
                    alert('❌ Please fill in all required fields (SKU, Name, Type)');
                    return;
                }

                if (parseInt(stock) < 0) {
                    alert('❌ Stock quantity cannot be negative');
                    return;
                }

                const currentStock = parseInt(stock);
                const reservedStock = 0;
                
                const componentData = {
                    sku: sku,
                    name: name,
                    type: type,
                    current_stock: currentStock,
                    reserved_stock: reservedStock,
                    // available_stock is generated automatically (current_stock - reserved_stock)
                    low_stock_threshold: parseInt(document.getElementById('componentThreshold').value) || 10,
                    retail_price: parseFloat(document.getElementById('componentRetailPrice').value) || 0,
                    wholesale_price: parseFloat(document.getElementById('componentWholesalePrice').value) || 0,
                    is_active: true
                };

                const { error } = await supabase
                    .from('components')
                    .insert(componentData);

                if (error) throw error;

                closeAddComponentModal();
                await loadAllData();
                updateDashboard();
                displayCurrentTab();
                
                alert('✅ Component added successfully!');
                
            } catch (error) {
                console.error('Error adding component:', error);
                alert('❌ Error adding component: ' + error.message);
            }
        }

        // Export data
        function exportData() {
            try {
                let csvContent = '';
                
                if (currentTab === 'products') {
                    csvContent = 'Product ID,Name,Brand,Model,Year,Variants Count,Components Used\n';
                    allProducts.forEach(product => {
                        const variants = allVariants.filter(v => v.product_id === product.id);
                        const components = new Set();
                        variants.forEach(variant => {
                            const rels = allRelationships.filter(r => r.variant_id === variant.id);
                            rels.forEach(rel => {
                                if (rel.components) components.add(rel.components.sku);
                            });
                        });
                        
                        csvContent += `"${product.product_id || ''}","${product.name || ''}","${product.brands?.name || ''}","${product.model || ''}","${product.year_range || ''}",${variants.length},"${Array.from(components).join(', ')}"\n`;
                    });
                } else if (currentTab === 'components') {
                    csvContent = 'SKU,Name,Type,Current Stock,Reserved,Available,Cost Price,Retail Price\n';
                    const individualComponents = allComponents.filter(c => !(c.sku || '').includes('+'));
                    individualComponents.forEach(component => {
                        csvContent += `"${component.sku}","${component.name || ''}","${component.type || ''}",${component.current_stock || 0},${component.reserved_stock || 0},${component.available_stock || 0},${component.cost_price || 0},${component.suggested_retail_price || 0}\n`;
                    });
                }

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `autolabs_${currentTab}_export_${new Date().toISOString().slice(0, 10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error exporting data: ' + error.message);
            }
        }

        // View Components function
        function viewComponents(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) {
                alert('Product not found');
                return;
            }

            const productVariants = allVariants.filter(v => v.product_id === product.id);
            const componentDetails = [];

            productVariants.forEach(variant => {
                const variantRelationships = allRelationships.filter(r => r.variant_id === variant.id);
                variantRelationships.forEach(rel => {
                    if (rel.components) {
                        componentDetails.push({
                            variant: variant.variant_name,
                            component: rel.components.sku,
                            quantity: rel.quantity
                        });
                    }
                });
            });

            let message = `Components for ${product.name}:\n\n`;
            componentDetails.forEach(detail => {
                message += `• ${detail.variant}: ${detail.component} (${detail.quantity}x)\n`;
            });

            alert(message);
        }

        // Toggle dropdown
        function toggleDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('active');
        }

        // Logout
        async function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'admin-login.html';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('userDropdown');
            const avatar = document.getElementById('userAvatar');
            
            if (!avatar.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Product Detail View Functions
        function showProductDetail(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) {
                alert('Product not found');
                return;
            }

            // Hide list view, show detail view
            document.getElementById('product-list-view').style.display = 'none';
            document.getElementById('product-detail-view').style.display = 'block';

            // Set product title
            document.getElementById('product-detail-title').textContent = product.name || 'Unnamed Product';
            
            // Show edit button and store current product ID
            document.getElementById('edit-product-btn').style.display = 'block';
            document.getElementById('edit-product-btn').setAttribute('data-product-id', product.id);

            // Simple clean layout without fancy container design
            const basicInfo = document.getElementById('product-basic-info');
            basicInfo.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; padding: 20px;">
                    <!-- Left Column: Product Image -->
                    <div>
                        <div style="
                            background: white; 
                            border: 2px solid #ccc; 
                            border-radius: 8px; 
                            padding: 20px; 
                            min-height: 400px; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center;
                        ">
                            ${product.image_url ? `
                                <img src="${product.image_url}" alt="Product Image" style="
                                    max-width: 100%; 
                                    max-height: 360px; 
                                    border-radius: 8px; 
                                    object-fit: contain;
                                ">
                            ` : `
                                <div style="text-align: center; color: #999;">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 12px;">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21,15 16,10 5,21"/>
                                    </svg>
                                    <p style="margin: 0; font-size: 14px;">No image available</p>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Right Column: Product Information -->
                    <div>
                        <div style="
                            background: white; 
                            border: 2px solid #ccc; 
                            border-radius: 8px;
                        ">
                            <!-- Header -->
                            <div style="
                                background: #f5f5f5; 
                                padding: 16px 20px; 
                                border-bottom: 2px solid #ccc; 
                                font-weight: 600; 
                                font-size: 16px; 
                                color: #333;
                            ">
                                Product Information
                            </div>
                            
                            <!-- Table Rows -->
                            <div style="display: grid; grid-template-columns: 140px 1fr; border-bottom: 1px solid #ccc;">
                                <div style="padding: 12px 16px; background: #f9f9f9; font-weight: 600; color: #666; border-right: 1px solid #ccc;">Name</div>
                                <div style="padding: 12px 16px; color: #333; font-weight: 600;">${product.name || 'Unnamed Product'}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 140px 1fr; border-bottom: 1px solid #ccc;">
                                <div style="padding: 12px 16px; background: #f9f9f9; font-weight: 600; color: #666; border-right: 1px solid #ccc;">Product ID</div>
                                <div style="padding: 12px 16px; color: #333; font-family: monospace;">${product.productID || product.product_id || 'N/A'}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 140px 1fr; border-bottom: 1px solid #ccc;">
                                <div style="padding: 12px 16px; background: #f9f9f9; font-weight: 600; color: #666; border-right: 1px solid #ccc;">Brand</div>
                                <div style="padding: 12px 16px; color: #333;">${product.brand || 'Unknown'}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 140px 1fr; border-bottom: 1px solid #ccc;">
                                <div style="padding: 12px 16px; background: #f9f9f9; font-weight: 600; color: #666; border-right: 1px solid #ccc;">Model</div>
                                <div style="padding: 12px 16px; color: #333;">${product.model || 'Not specified'}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 140px 1fr; border-bottom: 1px solid #ccc;">
                                <div style="padding: 12px 16px; background: #f9f9f9; font-weight: 600; color: #666; border-right: 1px solid #ccc;">Year</div>
                                <div style="padding: 12px 16px; color: #333;">${product.year || 'Not specified'}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 140px 1fr; border-bottom: 1px solid #ccc;">
                                <div style="padding: 12px 16px; background: #f9f9f9; font-weight: 600; color: #666; border-right: 1px solid #ccc;">Screen Size</div>
                                <div style="padding: 12px 16px; color: #333;">${product.screensize || 'Not specified'}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 140px 1fr; border-bottom: 1px solid #ccc;">
                                <div style="padding: 12px 16px; background: #f9f9f9; font-weight: 600; color: #666; border-right: 1px solid #ccc;">Category</div>
                                <div style="padding: 12px 16px; color: #333;">${product.category || 'Auto Parts'}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 140px 1fr;">
                                <div style="padding: 12px 16px; background: #f9f9f9; font-weight: 600; color: #666; border-right: 1px solid #ccc;">Description</div>
                                <div style="padding: 12px 16px; color: #333; line-height: 1.4;">${product.description || 'No description available'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Show variants with their SKU components
            displayProductVariants(productId);
        }

        function displayProductVariants(productId) {
            const variantsGrid = document.getElementById('product-variants-grid');
            const productVariants = allVariants
                .filter(v => v.product_id === productId)
                .sort((a, b) => (a.display_order || 999) - (b.display_order || 999)); // Sort by display_order

            if (productVariants.length === 0) {
                variantsGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <p>No variants found for this product.</p>
                        <button class="action-button add" onclick="showAddVariantModal('${productId}')">
                            Add First Variant
                        </button>
                    </div>
                `;
                return;
            }

            variantsGrid.innerHTML = '';

            productVariants.forEach(variant => {
                // Get components for this variant using new schema
                const variantRelationships = allRelationships.filter(r => r.variant_id === variant.id);
                const variantComponents = variantRelationships.map(rel => rel.components).filter(comp => comp);

                // Calculate stock from components (new schema - no stock in variants table)
                let availableStock = 0;
                let stockStatus = 'No Components';
                let stockClass = 'low';
                
                if (variantComponents.length > 0) {
                    // Calculate minimum available stock from all components
                    const componentStocks = variantRelationships.map(rel => {
                        const component = rel.components;
                        const quantityNeeded = rel.quantity_needed || 1;
                        return Math.floor((component.available_stock || 0) / quantityNeeded);
                    });
                    
                    availableStock = Math.min(...componentStocks);
                    
                    if (availableStock === 0) {
                        stockStatus = 'Out of Stock';
                        stockClass = 'low';
                    } else if (availableStock <= 10) {
                        stockStatus = 'Low Stock';
                        stockClass = 'medium';
                    } else {
                        stockStatus = 'In Stock';
                        stockClass = 'high';
                    }
                }

                // Build components display with SKUs and quantities
                let componentsDisplay = '';
                if (variantComponents && variantComponents.length > 0) {
                    const componentDetails = variantComponents
                        .map(comp => {
                            if (!comp.sku && !comp.name) return null;
                            const name = comp.sku || comp.name;
                            // Check for quantity from relationships
                            const relationship = variantRelationships.find(rel => 
                                rel.component_id === comp.id || rel.components?.id === comp.id
                            );
                            const qty = relationship?.quantity_needed || 1;
                            return qty > 1 ? `${name} x${qty}` : name;
                        })
                        .filter(Boolean)
                        .join(', ');
                    if (componentDetails) {
                        componentsDisplay = `<div style="font-size: 12px; color: var(--text-light); margin-top: 8px;">Components: ${componentDetails}</div>`;
                    }
                } else {
                    // Debug: Show what we're getting from relationships
                    const debugInfo = variantRelationships.length > 0 ? 
                        `Found ${variantRelationships.length} relationships but no valid components` : 
                        `No relationships found`;
                    componentsDisplay = `<div style="font-size: 10px; color: var(--warning); margin-top: 8px;">🔍 Debug: ${debugInfo}</div>`;
                    
                    // Log detailed debug info to console
                    if (variant.variant_name.toLowerCase().includes('honda') || variant.variant_name.toLowerCase().includes('bmw')) {
                        console.log('Debug variant:', variant.variant_name);
                        console.log('Relationships found:', variantRelationships);
                        console.log('Components from relationships:', variantComponents);
                    }
                }

                const variantCard = document.createElement('div');
                variantCard.className = 'variant-card';
                variantCard.innerHTML = `
                    <div class="variant-header">
                        <div>
                            <div class="variant-title">${variant.variant_name || 'Unnamed Variant'}</div>
                            <div class="variant-sku">Components: ${variantComponents.map(comp => comp.sku || comp.name).filter(Boolean).join(', ') || 'N/A'}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="action-button edit" onclick="editVariant('${variant.id}')" title="Edit Variant">
                                ✏️
                            </button>
                            <button class="action-button delete" onclick="deleteVariant('${variant.id}')" title="Delete Variant">
                                🗑️
                            </button>
                        </div>
                    </div>
                    
                    <div class="variant-info">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 16px;">
                            <div>
                                <span style="font-size: 11px; color: var(--text-light); display: block;">Stock</span>
                                <div>
                                    <span style="font-weight: 600; color: ${stockClass === 'high' ? 'var(--success-color)' : stockClass === 'medium' ? 'var(--warning)' : 'var(--error-color)'};">${availableStock} units</span>
                                    <div style="font-size: 10px; color: var(--text-light);">${stockStatus}</div>
                                </div>
                            </div>
                            <div>
                                <span style="font-size: 11px; color: var(--text-light); display: block;">Retail Price</span>
                                <span style="font-weight: 600;">RM ${(() => {
                                    const pricing = calculateVariantPricing(variant.id);
                                    return pricing.retailPrice.toFixed(2);
                                })()}</span>
                            </div>
                            <div>
                                <span style="font-size: 11px; color: var(--text-light); display: block;">Wholesale</span>
                                <span style="font-weight: 600;">RM ${(() => {
                                    const pricing = calculateVariantPricing(variant.id);
                                    return pricing.wholesalePrice.toFixed(2);
                                })()}</span>
                            </div>
                        </div>
                        ${componentsDisplay}
                        ${variantComponents.length === 0 ? 
                            `<div style="font-size: 10px; color: var(--warning); margin-top: 8px;">
                                ⚠️ No components linked<br>
                                <span style="font-size: 9px; color: var(--text-light);">
                                    Variant ID: ${variant.id} | Relationships: ${variantRelationships.length}
                                </span>
                            </div>` : ''
                        }
                    </div>
                `;

                variantsGrid.appendChild(variantCard);
            });
        }

        function showProductList() {
            // Hide detail view, show list view
            document.getElementById('product-detail-view').style.display = 'none';
            document.getElementById('product-list-view').style.display = 'block';
        }

        function editCurrentProduct() {
            const editBtn = document.getElementById('edit-product-btn');
            const productId = editBtn.getAttribute('data-product-id');
            if (productId) {
                editProduct(productId);
            }
        }

        // Image upload functions for Add Product - High Quality Client-Side
        function previewAddImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size too large. Please choose an image under 5MB.');
                    input.value = '';
                    return;
                }
                
                // Show loading state
                document.getElementById('addUploadPlaceholder').innerHTML = `
                    <div style="color: var(--primary-500);">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="animate-spin">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="m9 12 2 2 4-4"/>
                        </svg>
                        <p>Processing image...</p>
                    </div>
                `;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Use high resolution - up to 1600x1200 for excellent quality
                        const maxWidth = 1600;
                        const maxHeight = 1200;
                        let { width, height } = img;
                        
                        // Calculate optimal size maintaining aspect ratio
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // High quality rendering
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Use WebP format for better compression and quality
                        let imageDataUrl;
                        if (canvas.toDataURL('image/webp').indexOf('data:image/webp') === 0) {
                            // WebP supported - excellent quality and smaller size
                            imageDataUrl = canvas.toDataURL('image/webp', 0.92);
                        } else {
                            // Fallback to high quality JPEG
                            imageDataUrl = canvas.toDataURL('image/jpeg', 0.92);
                        }
                        
                        // Show the high-quality preview
                        document.getElementById('addPreviewImg').src = imageDataUrl;
                        document.getElementById('addImagePreview').style.display = 'block';
                        document.getElementById('addUploadPlaceholder').style.display = 'none';
                        
                        // Store the high-quality image data
                        document.getElementById('productImageUrl').value = imageDataUrl;
                        
                        console.log(`✅ High-quality image processed: ${width}x${height} (${Math.round(imageDataUrl.length / 1000)}KB)`);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function removeAddImage() {
            // Reset file input
            document.getElementById('productImage').value = '';
            document.getElementById('productImageUrl').value = '';
            
            // Hide preview and show upload area
            document.getElementById('addImagePreview').style.display = 'none';
            document.getElementById('addUploadPlaceholder').style.display = 'block';
            
            // Reset upload placeholder content
            document.getElementById('addUploadPlaceholder').innerHTML = `
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21,15 16,10 5,21"/>
                </svg>
                <p>Click to upload product image</p>
                <small>PNG, JPG up to 5MB</small>
            `;
            
            console.log('✅ Image removed - ready for new upload');
        }

        // Image upload functions for Edit Product - High Quality Client-Side
        function previewEditImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size too large. Please choose an image under 5MB.');
                    input.value = '';
                    return;
                }
                
                // Show loading state
                document.getElementById('editUploadPlaceholder').innerHTML = `
                    <div style="color: var(--primary-500);">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="animate-spin">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="m9 12 2 2 4-4"/>
                        </svg>
                        <p>Processing image...</p>
                    </div>
                `;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Use high resolution - up to 1600x1200 for excellent quality
                        const maxWidth = 1600;
                        const maxHeight = 1200;
                        let { width, height } = img;
                        
                        // Calculate optimal size maintaining aspect ratio
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // High quality rendering
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Use WebP format for better compression and quality
                        let imageDataUrl;
                        if (canvas.toDataURL('image/webp').indexOf('data:image/webp') === 0) {
                            // WebP supported - excellent quality and smaller size
                            imageDataUrl = canvas.toDataURL('image/webp', 0.92);
                        } else {
                            // Fallback to high quality JPEG
                            imageDataUrl = canvas.toDataURL('image/jpeg', 0.92);
                        }
                        
                        // Show the high-quality preview
                        document.getElementById('editPreviewImg').src = imageDataUrl;
                        document.getElementById('editImagePreview').style.display = 'block';
                        document.getElementById('editUploadPlaceholder').style.display = 'none';
                        
                        // Store the high-quality image data
                        document.getElementById('editProductImageUrl').value = imageDataUrl;
                        
                        console.log(`✅ High-quality image processed: ${width}x${height} (${Math.round(imageDataUrl.length / 1000)}KB)`);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function removeEditImage() {
            // Reset file input
            document.getElementById('editProductImage').value = '';
            document.getElementById('editProductImageUrl').value = '';
            
            // Hide preview and show upload area
            document.getElementById('editImagePreview').style.display = 'none';
            document.getElementById('editUploadPlaceholder').style.display = 'block';
            
            // Reset upload placeholder content
            document.getElementById('editUploadPlaceholder').innerHTML = `
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21,15 16,10 5,21"/>
                </svg>
                <p>Click to upload product image</p>
                <small>PNG, JPG up to 5MB</small>
            `;
            
            console.log('✅ Image removed - ready for new upload');
        }

        function showAddVariantModal(productId) {
            // This function would show a modal to add new variants
            // For now, show a placeholder
            alert(`Add variant functionality for product ID: ${productId}\nThis would open a modal to create new variants with component mapping.`);
        }

        function editVariant(variantId) {
            // This function would show a modal to edit variant details
            alert(`Edit variant functionality for variant ID: ${variantId}\nThis would open a modal to edit variant details and component relationships.`);
        }

        function deleteVariant(variantId) {
            // This function would delete a variant with confirmation
            const variant = allVariants.find(v => v.id === variantId);
            if (!variant) return;
            
            const confirmDelete = confirm(`Are you sure you want to delete variant: ${variant.variant_name}?\nThis action cannot be undone.`);
            if (confirmDelete) {
                alert(`Delete variant functionality for: ${variant.variant_name}\nThis would remove the variant and its relationships from the database.`);
            }
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>

    <!-- Price Edit Modal -->
    <div class="modal" id="priceEditModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Component Pricing</h3>
                <button class="close-button" id="closePriceEditModal">&times;</button>
            </div>
            <form id="priceEditForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Component:</label>
                        <div id="editPriceComponentInfo" style="font-weight: bold; margin-bottom: 10px;"></div>
                    </div>
                    
                    <div id="editPriceVariantInfo" style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-size: 14px; color: var(--text-light);"></div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editNormalPrice">Normal Price (RM)</label>
                            <input type="number" step="0.01" class="form-control" id="editNormalPrice" required>
                        </div>
                        <div class="form-group">
                            <label for="editWholesalePrice">Wholesale Price (RM)</label>
                            <input type="number" step="0.01" class="form-control" id="editWholesalePrice" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelPriceEditBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Prices</button>
                </div>
            </form>
        </div>
    </div>

</body>

</html>