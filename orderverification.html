<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>Order Verification - AutoLab</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #52c41a;
            --secondary-color: #1890ff;
            --tertiary-color: #fa8c16;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --error-color: #f5222d;
            --info-color: #1890ff;
            --background-color: #f0f2f5;
            --sidebar-width: 225px;
            --header-height: 60px;
            --text-color: #333;
            --text-light: #666;
            --border-radius: 4px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #222;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
        }

        .logo-container {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #333;
            height: var(--header-height);
        }

        .logo {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .logo-text {
            font-size: 20px;
            font-weight: bold;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            padding: 10px 0;
            flex-grow: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #ddd;
            text-decoration: none;
            transition: all 0.3s;
            gap: 12px;
        }

        .nav-item:hover {
            background-color: #333;
        }

        .nav-item.active {
            background-color: #e21b1b;
            color: white;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-item.sub-item {
            padding-left: 40px;
            position: relative;
            background-color: rgba(0, 0, 0, 0.1);
            border-left: 3px solid transparent;
        }

        .nav-item.sub-item::before {
            content: '';
            position: absolute;
            left: 23px;
            top: 0;
            height: 100%;
            width: 1px;
            background-color: #444;
        }

        .nav-item.sub-item .sub-icon {
            margin-left: -12px;
        }

        .nav-item.sub-item.active {
            background-color: #e21b1b;
            border-left: 3px solid #fff;
        }

        .nav-item.sub-item:hover {
            background-color: #333;
            border-left: 3px solid #888;
        }

        .nav-item.sub-item.active:hover {
            background-color: #c91818;
            border-left: 3px solid #fff;
        }

        .nav-text {
            font-size: 14px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
        }

        .header {
            height: var(--header-height);
            background-color: white;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            position: sticky;
            top: 0;
            z-index: 99;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: bold;
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
        }

        .dropdown-menu {
            position: absolute;
            top: 45px;
            right: -60px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            min-width: 200px;
            display: none;
            z-index: 100;
        }

        .dropdown-menu.active {
            display: block;
        }

        .dropdown-item {
            padding: 8px 16px;
            display: block;
            color: var(--text-color);
        }

        .dropdown-divider {
            height: 1px;
            background-color: #eee;
            margin: 8px 0;
        }

        .dropdown-item.logout {
            color: #e21b1b;
            cursor: pointer;
        }

        .dropdown-item.logout:hover {
            background-color: #f8f8f8;
        }

        .content {
            padding: 24px;
        }

        .page-title {
            font-size: 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-btn {
            padding: 15px 25px;
            background: transparent;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-btn.active {
            background: #007bff;
            color: white;
        }

        .tab-btn:not(.active):hover {
            background: #f8f9fa;
        }

        .badge {
            background: #dc3545;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 8px;
        }

        .tab-content {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .order-card {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .order-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .order-id {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }

        .order-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-processing {
            background: #fff3cd;
            color: #856404;
        }

        .order-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-item i {
            color: #6c757d;
            width: 16px;
        }

        .approval-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-approve {
            background: #28a745;
            color: white;
        }

        .btn-approve:hover {
            background: #218838;
        }

        .btn-reject {
            background: #dc3545;
            color: white;
        }

        .btn-reject:hover {
            background: #c82333;
        }

        .empty-state {
            text-align: center;
            color: #6c757d;
            padding: 60px 20px;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .priority-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .priority-urgent { background: #dc3545; }
        .priority-high { background: #fd7e14; }
        .priority-normal { background: #28a745; }
        .priority-low { background: #6c757d; }

        .time-badge {
            background: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .driver-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        /* Loading indicator */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        .success-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }

        .success-notification.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- Sidebar Menu -->
        <div class="sidebar">
            <div class="logo-container">
                <svg class="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6Z" />
                </svg>
                <div class="logo-text">Autolabs</div>
            </div>
            <button onclick="testN8nConnection()" style="background: #ff6b35; color: white; padding: 10px; border: none; border-radius: 5px; margin: 10px;">
                🧪 Test n8n Connection
            </button>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </div>
                    <div class="nav-text">Admin Dashboard</div>
                </a>
                <a href="order.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                        </svg>
                    </div>
                    <div class="nav-text">Order Page</div>
                </a>
                <a href="orderverification.html" class="nav-item sub-item active">
                    <div class="nav-icon sub-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                    <div class="nav-text">Orders Verification</div>
                </a>
                <a href="orderwarehouse.html" class="nav-item sub-item">
                    <div class="nav-icon sub-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 12h-6l-2 3h-4l-2-3H2"></path>
                            <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path>
                        </svg>
                    </div>
                    <div class="nav-text">Warehouse Operations</div>
                </a>
                <a href="stock.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                        </svg>
                    </div>
                    <div class="nav-text">Inventory Page</div>
                </a>
                <a href="customer.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="nav-text">Customer Page</div>
                </a>
                <a href="staff.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="nav-text">Staff Page</div>
                </a>
                <a href="reports.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                    </div>
                    <div class="nav-text">Reports Page</div>
                </a>
                <a href="communication center page.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                        </svg>
                    </div>
                    <div class="nav-text">Communication Center</div>
                </a>
                <a href="#" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </div>
                    <div class="nav-text">Settings Page</div>
                </a>
            </div>
        </div>

        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">
                        AD
                    </div>
                    <div>
                        <div style="font-weight: 500;" id="userName">Admin User</div>
                        <div style="font-size: 12px; color: var(--text-light);">Administrator</div>
                    </div>
                    <!-- Dropdown menu -->
                    <div class="dropdown-menu" id="userDropdown">
                        <div class="dropdown-item" id="userFullName">Admin User</div>
                        <div class="dropdown-item" id="userStaffId">Staff ID: 8888</div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item logout" id="logoutButton">Logout</div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="content">
                <div class="page-title">
                    <span>WhatsApp Order Workflow Management</span>
                </div>

                <div class="tabs">
                    <button class="tab-btn" data-tab="awaiting">
                        <i class="fas fa-clock"></i> Awaiting WhatsApp Confirmation
                        <span class="badge" id="awaiting-count">0</span>
                    </button>
                    <button class="tab-btn" data-tab="confirmed">
                        <i class="fas fa-credit-card"></i> Confirmed - Pending Payment
                        <span class="badge" id="confirmed-count">0</span>
                    </button>
                    <button class="tab-btn active" data-tab="admin-approval">
                        <i class="fas fa-user-check"></i> Pending Admin Approval
                        <span class="badge" id="approval-count">0</span>
                    </button>
                    <button class="tab-btn" data-tab="approved">
                        <i class="fas fa-check-circle"></i> Approved & Processing
                        <span class="badge" id="approved-count">0</span>
                    </button>
                </div>

                <div class="tab-content">
                    <!-- Awaiting WhatsApp Confirmation Tab -->
                    <div class="tab-panel" id="awaiting-panel">
                        <div id="awaiting-orders-container">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <span>Loading awaiting confirmation orders...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Confirmed - Pending Payment Tab -->
                    <div class="tab-panel" id="confirmed-panel">
                        <div id="confirmed-orders-container">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <span>Loading confirmed orders...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Admin Approval Tab -->
                    <div class="tab-panel active" id="admin-approval-panel">
                        <div id="approval-orders-container">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <span>Loading orders pending approval...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Approved & Processing Tab -->
                    <div class="tab-panel" id="approved-panel">
                        <div id="approved-orders-container">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <span>Loading approved orders...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success notification -->
    <div class="success-notification" id="successNotification">
        <i class="fas fa-check-circle" style="margin-right: 10px;"></i>
        <span id="notificationMessage">Order approved successfully!</span>
    </div>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://bbwimjvqpyxwhovihtfm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJid2ltanZxcHl4d2hvdmlodGZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MjAwMDksImV4cCI6MjA2MDk5NjAwOX0._D3wackPNKg-IbiswH7M-3wqeQRP6ujMmcJ9bb7_1z0';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // n8n Webhook Configuration for approval notifications
        const N8N_WEBHOOK_URL = 'https://apipietech.app.n8n.cloud/webhook-test/unified-whatsapp';

        // Global variables
        let currentUserDetails = null;
        let allStaff = [];
        let orderCounts = {
            awaiting: 0,
            confirmed: 0,
            approval: 0,
            approved: 0
        };

        // Available drivers data
        const availableDrivers = [
            { id: 'driver1', name: 'Ahmad Rahman', phone: '0123456789', status: 'available' },
            { id: 'driver2', name: 'Siti Nurhaliza', phone: '0123456788', status: 'available' },
            { id: 'driver3', name: 'Mohammad Zainal', phone: '0123456787', status: 'busy' },
            { id: 'driver4', name: 'Fatimah Ali', phone: '0123456786', status: 'available' },
            { id: 'lalamove', name: 'Lalamove (External)', phone: 'External', status: 'available' }
        ];

        // Check if user is authenticated
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = 'admin-login.html';
                return null;
            }
            return user;
        }

        // Get user details from database
        async function getUserDetails(userId) {
            const { data, error } = await supabase
                .from('staff_members')
                .select('*')
                .eq('id', userId)
                .single();

            if (error) {
                console.error('Error fetching user details:', error);
                return null;
            }
            return data;
        }

        // Update user interface with user details
        function updateUserInterface(userData) {
            currentUserDetails = userData;
            const initials = userData.first_name.charAt(0) + userData.last_name.charAt(0);
            document.getElementById('userAvatar').textContent = initials;
            document.getElementById('userName').textContent = `${userData.first_name} ${userData.last_name}`;
            document.getElementById('userFullName').textContent = `${userData.first_name} ${userData.last_name}`;
            document.getElementById('userStaffId').textContent = `Staff ID: ${userData.staff_id}`;
        }

        // Handle logout
        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Error signing out:', error);
                alert('Error signing out. Please try again.');
            } else {
                sessionStorage.removeItem('currentUser');
                window.location.href = 'admin-login.html';
            }
        }

        // Toggle dropdown menu
        function toggleDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('active');
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active class from all tabs and panels
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding panel
                btn.classList.add('active');
                const tabId = btn.dataset.tab + '-panel';
                document.getElementById(tabId).classList.add('active');
                
                // Load data for the selected tab
                loadTabData(btn.dataset.tab);
            });
        });

        // Load orders for specific tab
        async function loadTabData(tab) {
            try {
                switch(tab) {
                    case 'awaiting':
                        await loadAwaitingOrders();
                        break;
                    case 'confirmed':
                        await loadConfirmedOrders();
                        break;
                    case 'admin-approval':
                        await loadAdminApprovalOrders();
                        break;
                    case 'approved':
                        await loadApprovedOrders();
                        break;
                }
            } catch (error) {
                console.error(`Error loading ${tab} orders:`, error);
            }
        }

        // Load orders awaiting WhatsApp confirmation
        async function loadAwaitingOrders() {
            const container = document.getElementById('awaiting-orders-container');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>Loading awaiting confirmation orders...</span>
                </div>
            `;

            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*, customers(name)')
                    .eq('status', 'awaiting_confirmation')
                    .order('order_date', { ascending: false });

                if (error) throw error;

                orderCounts.awaiting = orders?.length || 0;
                document.getElementById('awaiting-count').textContent = orderCounts.awaiting;

                if (!orders || orders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-hourglass-half"></i>
                            <h3>No Orders Awaiting Confirmation</h3>
                            <p>Orders will appear here when customers haven't confirmed via WhatsApp yet.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = orders.map(order => createSimpleOrderCard(order, 'awaiting')).join('');
            } catch (error) {
                console.error('Error loading awaiting orders:', error);
                container.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading orders</p></div>`;
            }
        }

        // Load orders confirmed but pending payment
        async function loadConfirmedOrders() {
            const container = document.getElementById('confirmed-orders-container');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>Loading confirmed orders...</span>
                </div>
            `;

            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*, customers(name)')
                    .eq('status', 'pending_payment')
                    .order('confirmed_at', { ascending: false });

                if (error) throw error;

                orderCounts.confirmed = orders?.length || 0;
                document.getElementById('confirmed-count').textContent = orderCounts.confirmed;

                if (!orders || orders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-credit-card"></i>
                            <h3>No Orders Pending Payment</h3>
                            <p>Confirmed orders awaiting payment will appear here.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = orders.map(order => createSimpleOrderCard(order, 'confirmed')).join('');
            } catch (error) {
                console.error('Error loading confirmed orders:', error);
                container.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading orders</p></div>`;
            }
        }

        // Load orders needing admin approval (MAIN FUNCTION - UPDATED)
        async function loadAdminApprovalOrders() {
            const container = document.getElementById('approval-orders-container');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>Loading orders pending approval...</span>
                </div>
            `;

            try {
                // UPDATED: Now looks for 'pending_confirmation' status (paid orders waiting for admin approval)
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*, customers(name)')
                    .eq('status', 'pending_confirmation')
                    .order('paid_at', { ascending: false });

                if (error) throw error;

                orderCounts.approval = orders?.length || 0;
                document.getElementById('approval-count').textContent = orderCounts.approval;

                if (!orders || orders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <h3>No Orders Need Admin Approval</h3>
                            <p>All paid orders have been processed or there are no paid orders.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = orders.map(order => createOrderApprovalCard(order)).join('');
            } catch (error) {
                console.error('Error loading approval orders:', error);
                container.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading orders</p></div>`;
            }
        }

        // Load approved orders (UPDATED - show detailed info)
        async function loadApprovedOrders() {
            const container = document.getElementById('approved-orders-container');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>Loading approved orders...</span>
                </div>
            `;

            try {
                // UPDATED: Now looks for 'processing' status (approved orders)
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*, customers(name)')
                    .eq('status', 'processing')
                    .order('approved_at', { ascending: false });

                if (error) throw error;

                orderCounts.approved = orders?.length || 0;
                document.getElementById('approved-count').textContent = orderCounts.approved;

                if (!orders || orders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-truck"></i>
                            <h3>No Approved Orders</h3>
                            <p>Approved orders ready for delivery will appear here.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = orders.map(order => createDetailedApprovedOrderCard(order)).join('');
            } catch (error) {
                console.error('Error loading approved orders:', error);
                container.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading orders</p></div>`;
            }
        }

        // NEW: Create detailed approved order card showing processing information
        function createDetailedApprovedOrderCard(order) {
            const customerName = order.customers ? order.customers.name : 'Unknown Customer';
            const approvedDate = order.approved_at ? new Date(order.approved_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : 'Unknown';

            const deliveryDate = order.estimated_delivery_date ? new Date(order.estimated_delivery_date).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : 'Not set';

            const priorityBadge = {
                'urgent': { color: '#dc3545', text: 'URGENT' },
                'high': { color: '#fd7e14', text: 'HIGH' },
                'normal': { color: '#28a745', text: 'NORMAL' },
                'low': { color: '#6c757d', text: 'LOW' }
            }[order.processing_priority] || { color: '#28a745', text: 'NORMAL' };

            return `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <div class="order-id">
                                <span class="priority-indicator" style="background: ${priorityBadge.color};"></span>
                                ✅ ${order.order_id}
                            </div>
                            <div class="time-badge">Approved ${approvedDate}</div>
                        </div>
                        <div class="order-status" style="color: #52c41a; background: #f6ffed; border: 1px solid #b7eb8f;">
                            ${priorityBadge.text} - PROCESSING
                        </div>
                    </div>
                    
                    <div class="order-details">
                        <div class="detail-item">
                            <i class="fas fa-user"></i>
                            <span><strong>${customerName}</strong></span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-phone"></i>
                            <span>${order.customer_phone || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${order.address || 'Address not provided'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-dollar-sign"></i>
                            <span>RM ${parseFloat(order.amount || 0).toFixed(2)}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-user-tie"></i>
                            <span><strong>Driver:</strong> ${order.assigned_driver || 'Not assigned'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar-alt"></i>
                            <span><strong>Delivery:</strong> ${deliveryDate}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-clock"></i>
                            <span><strong>Time:</strong> ${order.estimated_delivery_time || 'Not set'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-tools"></i>
                            <span><strong>Installation:</strong> ${order.requires_installation ? 'Required' : 'Not required'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-stopwatch"></i>
                            <span><strong>Prep Time:</strong> ${order.preparation_hours || 2} hours</span>
                        </div>
                    </div>

                    ${order.delivery_instructions || order.installation_instructions || order.admin_notes ? `
                        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            ${order.delivery_instructions ? `
                                <div style="margin-bottom: 10px;">
                                    <strong><i class="fas fa-clipboard-list"></i> Delivery Instructions:</strong>
                                    <div style="margin-top: 5px; color: #666;">${order.delivery_instructions}</div>
                                </div>
                            ` : ''}
                            ${order.installation_instructions ? `
                                <div style="margin-bottom: 10px;">
                                    <strong><i class="fas fa-wrench"></i> Installation Instructions:</strong>
                                    <div style="margin-top: 5px; color: #666;">${order.installation_instructions}</div>
                                </div>
                            ` : ''}
                            ${order.admin_notes ? `
                                <div>
                                    <strong><i class="fas fa-sticky-note"></i> Admin Notes:</strong>
                                    <div style="margin-top: 5px; color: #666;">${order.admin_notes}</div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Create simple order card for display-only tabs
        function createSimpleOrderCard(order, type) {
            const customerName = order.customers ? order.customers.name : 'Unknown Customer';
            const orderDate = new Date(order.order_date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const statusConfig = {
                'awaiting': { icon: '📱', text: 'Awaiting WhatsApp Confirmation', color: '#fa8c16' },
                'confirmed': { icon: '💳', text: 'Confirmed - Pending Payment', color: '#1890ff' },
                'approved': { icon: '⚙️', text: 'Processing', color: '#52c41a' }
            };

            const status = statusConfig[type] || statusConfig['awaiting'];

            return `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <div class="order-id">${status.icon} ${order.order_id}</div>
                            <div class="time-badge">${type === 'confirmed' ? 'Confirmed' : type === 'approved' ? 'Approved' : 'Placed'} ${orderDate}</div>
                        </div>
                        <div class="order-status status-processing" style="color: ${status.color};">${status.text}</div>
                    </div>
                    
                    <div class="order-details">
                        <div class="detail-item">
                            <i class="fas fa-user"></i>
                            <span><strong>${customerName}</strong></span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-phone"></i>
                            <span>${order.customer_phone || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${order.address || 'Address not provided'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-dollar-sign"></i>
                            <span>RM ${parseFloat(order.amount || 0).toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Create detailed order approval card (MAIN APPROVAL FUNCTIONALITY - ENHANCED)
        function createOrderApprovalCard(order) {
            const customerName = order.customers ? order.customers.name : 'Unknown Customer';
            const orderDate = new Date(order.order_date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const paidDate = order.paid_at ? new Date(order.paid_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : 'Just now';

            const hoursWaiting = order.paid_at ? 
                Math.round((new Date() - new Date(order.paid_at)) / (1000 * 60 * 60)) : 0;

            // Set default delivery date (tomorrow)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const defaultDeliveryDate = tomorrow.toISOString().split('T')[0];

            return `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <div class="order-id">
                                <span class="priority-indicator priority-${order.is_urgent ? 'urgent' : 'normal'}"></span>
                                ${order.order_id}
                            </div>
                            <div class="time-badge">Payment completed ${paidDate} (${hoursWaiting}h ago)</div>
                        </div>
                        <div class="order-status status-processing">⏳ Pending Admin Approval</div>
                    </div>
                    
                    <div class="order-details">
                        <div class="detail-item">
                            <i class="fas fa-user"></i>
                            <span><strong>${customerName}</strong></span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-phone"></i>
                            <span>${order.customer_phone || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${order.address || 'Address not provided'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-dollar-sign"></i>
                            <span>RM ${parseFloat(order.amount || 0).toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="approval-form">
                        <h4><i class="fas fa-cog"></i> Order Processing Details</h4>
                        
                        <form class="approval-form-content" data-order-id="${order.order_id}" data-order-db-id="${order.id}">
                            <div class="form-grid">
                                <!-- Driver Assignment -->
                                <div class="form-group">
                                    <label for="driver-${order.order_id}">
                                        <i class="fas fa-user-tie"></i> Assign Driver
                                    </label>
                                    <select id="driver-${order.order_id}" name="assigned_driver" required>
                                        <option value="">Select Driver</option>
                                        ${availableDrivers.map(driver => `
                                            <option value="${driver.name}" ${driver.status === 'busy' ? 'disabled' : ''}>
                                                ${driver.name} - ${driver.phone} 
                                                ${driver.status === 'busy' ? '(Busy)' : '(Available)'}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <!-- Delivery Date -->
                                <div class="form-group">
                                    <label for="delivery-date-${order.order_id}">
                                        <i class="fas fa-calendar"></i> Delivery Date
                                    </label>
                                    <input type="date" id="delivery-date-${order.order_id}" 
                                           name="estimated_delivery_date" required
                                           value="${defaultDeliveryDate}"
                                           min="${new Date().toISOString().split('T')[0]}">
                                </div>
                                
                                <!-- Delivery Time -->
                                <div class="form-group">
                                    <label for="delivery-time-${order.order_id}">
                                        <i class="fas fa-clock"></i> Estimated Arrival Time
                                    </label>
                                    <input type="time" id="delivery-time-${order.order_id}" 
                                           name="estimated_delivery_time" required
                                           value="14:00">
                                </div>
                                
                                <!-- Priority -->
                                <div class="form-group">
                                    <label for="priority-${order.order_id}">
                                        <i class="fas fa-flag"></i> Priority Level
                                    </label>
                                    <select id="priority-${order.order_id}" name="processing_priority">
                                        <option value="normal" ${!order.is_urgent ? 'selected' : ''}>Normal</option>
                                        <option value="high">High</option>
                                        <option value="urgent" ${order.is_urgent ? 'selected' : ''}>Urgent</option>
                                        <option value="low">Low</option>
                                    </select>
                                </div>
                                
                                <!-- Installation Required -->
                                <div class="form-group">
                                    <label for="installation-${order.order_id}">
                                        <i class="fas fa-tools"></i> Installation Required
                                    </label>
                                    <select id="installation-${order.order_id}" name="requires_installation">
                                        <option value="false">No Installation</option>
                                        <option value="true">Installation Required</option>
                                    </select>
                                </div>
                                
                                <!-- Preparation Time -->
                                <div class="form-group">
                                    <label for="prep-time-${order.order_id}">
                                        <i class="fas fa-stopwatch"></i> Preparation Time (hours)
                                    </label>
                                    <select id="prep-time-${order.order_id}" name="preparation_hours">
                                        <option value="1">1 hour</option>
                                        <option value="2" selected>2 hours</option>
                                        <option value="4">4 hours</option>
                                        <option value="8">8 hours (Next day)</option>
                                        <option value="24">24 hours</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Delivery Instructions -->
                            <div class="form-group">
                                <label for="delivery-instructions-${order.order_id}">
                                    <i class="fas fa-clipboard-list"></i> Delivery Instructions
                                </label>
                                <textarea id="delivery-instructions-${order.order_id}" 
                                          name="delivery_instructions" 
                                          placeholder="Special delivery notes, access instructions, contact person, etc."></textarea>
                            </div>
                            
                            <!-- Installation Instructions (if applicable) -->
                            <div class="form-group">
                                <label for="installation-instructions-${order.order_id}">
                                    <i class="fas fa-wrench"></i> Installation Instructions
                                </label>
                                <textarea id="installation-instructions-${order.order_id}" 
                                          name="installation_instructions" 
                                          placeholder="Special installation requirements, tools needed, preparations, etc."></textarea>
                            </div>
                            
                            <!-- Admin Notes -->
                            <div class="form-group">
                                <label for="admin-notes-${order.order_id}">
                                    <i class="fas fa-sticky-note"></i> Admin Notes
                                </label>
                                <textarea id="admin-notes-${order.order_id}" 
                                          name="admin_notes" 
                                          placeholder="Internal notes for warehouse, driver, customer service, or other staff"></textarea>
                            </div>
                            
                            <div class="action-buttons">
                                <button type="button" class="btn btn-reject" onclick="rejectOrder('${order.order_id}', '${order.id}')">
                                    <i class="fas fa-times"></i> Reject Order
                                </button>
                                <button type="submit" class="btn btn-approve">
                                    <i class="fas fa-check"></i> Approve & Process Order
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        // ENHANCED: Handle approval form submission with detailed WhatsApp notification
        document.addEventListener('submit', async (e) => {
            if (e.target.classList.contains('approval-form-content')) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const orderId = e.target.dataset.orderId;
                const orderDbId = e.target.dataset.orderDbId;
                
                const submitButton = e.target.querySelector('.btn-approve');
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                submitButton.disabled = true;
                
                try {
                    // Prepare approval data
                    const approvalData = {
                        assigned_driver: formData.get('assigned_driver'),
                        estimated_delivery_date: formData.get('estimated_delivery_date'),
                        estimated_delivery_time: formData.get('estimated_delivery_time'),
                        processing_priority: formData.get('processing_priority'),
                        requires_installation: formData.get('requires_installation') === 'true',
                        preparation_hours: parseInt(formData.get('preparation_hours')),
                        delivery_instructions: formData.get('delivery_instructions'),
                        installation_instructions: formData.get('installation_instructions'),
                        admin_notes: formData.get('admin_notes'),
                        status: 'processing', // UPDATED: Changes from pending_confirmation to processing
                        approved_at: new Date().toISOString(),
                        approved_by: currentUserDetails?.id,
                        prepared_at: null // Will be set later in warehouse
                    };
                    
                    // Update order in database
                    const { error: updateError } = await supabase
                        .from('orders')
                        .update(approvalData)
                        .eq('id', orderDbId);
                    
                    if (updateError) {
                        throw new Error('Failed to update order: ' + updateError.message);
                    }
                    
                    // Get full order details for WhatsApp notification
                    const { data: fullOrder, error: orderError } = await supabase
                        .from('orders')
                        .select('*, customers(name, phone)')
                        .eq('id', orderDbId)
                        .single();
                    
                    if (orderError) {
                        console.error('Error fetching order details:', orderError);
                    }
                    
                    // ENHANCED: Send detailed WhatsApp notification
                    if (fullOrder) {
                        const notificationSent = await sendDetailedApprovalNotification(fullOrder, approvalData);
                        
                        if (notificationSent) {
                            showSuccessNotification('Order approved successfully! Customer has been notified via WhatsApp.');
                        } else {
                            showSuccessNotification('Order approved successfully! (WhatsApp notification failed - please contact customer manually)');
                        }
                    } else {
                        showSuccessNotification('Order approved successfully!');
                    }
                    
                    // Refresh the approval orders list
                    await loadAdminApprovalOrders();
                    
                    // Also refresh approved orders to show the newly approved order
                    await loadApprovedOrders();
                    
                } catch (error) {
                    console.error('Error approving order:', error);
                    alert('Error approving order: ' + error.message);
                    
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                }
            }
        });

        // TEST FUNCTION - Add this temporarily to test n8n connection
        async function testN8nConnection() {
            try {
                console.log('🧪 Testing n8n connection...');
                console.log('🔗 Webhook URL:', N8N_WEBHOOK_URL);
                
                const testPayload = {
                    test: true,
                    message: 'Test from admin panel',
                    timestamp: new Date().toISOString()
                };

                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testPayload)
                });

                console.log('📡 Response status:', response.status);
                console.log('📡 Response headers:', [...response.headers.entries()]);
                
                if (response.ok) {
                    const responseText = await response.text();
                    console.log('✅ n8n test successful. Response:', responseText);
                    alert('✅ n8n connection successful!');
                } else {
                    const errorText = await response.text();
                    console.error('❌ n8n test failed:', response.status, errorText);
                    alert(`❌ n8n connection failed: ${response.status} - ${errorText}`);
                }

            } catch (error) {
                console.error('🔥 Network error testing n8n:', error);
                alert(`🔥 Network error: ${error.message}`);
            }
        }

        // ENHANCED: Send detailed WhatsApp notification via n8n (bypassing routing)
        async function sendDetailedApprovalNotification(order, approvalData) {
            try {
                const customerPhone = order.customers?.phone || order.customer_phone;
                if (!customerPhone) {
                    console.warn('No customer phone number available for WhatsApp notification');
                    return false;
                }

                // Format delivery date and time
                const deliveryDate = new Date(approvalData.estimated_delivery_date).toLocaleDateString('en-MY', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const deliveryTime = approvalData.estimated_delivery_time;
                
                // Format installation info
                const installationText = approvalData.requires_installation 
                    ? '✅ *Installation Included*\n   Our technician will install your products on-site'
                    : '📦 *Delivery Only*\n   Products will be delivered and handed over';
                
                // Format priority badge
                const priorityBadge = {
                    'urgent': '🚨 *URGENT ORDER*',
                    'high': '⚡ *HIGH PRIORITY*', 
                    'normal': '📋 *STANDARD ORDER*',
                    'low': '📝 *LOW PRIORITY*'
                }[approvalData.processing_priority] || '📋 *STANDARD ORDER*';
                
                // Create detailed approval message
                const approvalMessage = `🎉 *AutoLab Order Approved!*

${priorityBadge}

📋 *ORDER DETAILS:*
• Order ID: *${order.order_id}*
• Customer: ${order.customers?.name || 'Valued Customer'}
• Amount: *RM ${parseFloat(order.amount).toFixed(2)}*

🚚 *DELIVERY SCHEDULE:*
• Date: *${deliveryDate}*
• Time: *${deliveryTime}*
• Driver: *${approvalData.assigned_driver}*

📍 *DELIVERY ADDRESS:*
${order.address}

🔧 *SERVICE TYPE:*
${installationText}

⏱️ *PREPARATION:*
• Estimated prep time: ${approvalData.preparation_hours} hour(s)
• Your order is now being prepared

${approvalData.delivery_instructions ? `📝 *DELIVERY NOTES:*\n${approvalData.delivery_instructions}\n\n` : ''}${approvalData.installation_instructions && approvalData.requires_installation ? `🔧 *INSTALLATION NOTES:*\n${approvalData.installation_instructions}\n\n` : ''}📞 *WHAT'S NEXT:*
1. Our team will prepare your order
2. Driver will contact you 30 minutes before delivery
3. Please ensure someone is available at the delivery address
4. Have your Order ID ready: *${order.order_id}*

🔄 *ORDER STATUS UPDATES:*
You'll receive notifications when:
• Order preparation is completed
• Driver is dispatched
• Driver is arriving (30 min notice)

💬 *Need to reschedule or have questions?*
Reply to this chat with your Order ID and your message.

Thank you for choosing AutoLab! 🚗✨

*Estimated delivery: ${deliveryDate} at ${deliveryTime}*`;

                // Send via n8n but with special format that bypasses message routing
                const payload = {
                    action: 'direct_whatsapp_send',
                    source: 'admin_approval',
                    bypass_routing: true,
                    to: customerPhone,
                    type: 'text',
                    text: {
                        body: approvalMessage
                    },
                    _metadata: {
                        source: 'admin_approval_direct',
                        timestamp: new Date().toISOString(),
                        order_id: order.order_id,
                        approved_by: currentUserDetails?.id
                    }
                };

                console.log('🚀 Sending detailed approval notification via n8n...');
                console.log('📱 Customer phone:', customerPhone);
                console.log('📋 Order ID:', order.order_id);

                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    console.log('✅ Detailed approval notification sent successfully via n8n');
                    return true;
                } else {
                    console.error('❌ Failed to send approval notification:', response.status);
                    return false;
                }

            } catch (error) {
                console.error('Error sending detailed approval notification:', error);
                return false;
            }
        }

        // Show success notification
        function showSuccessNotification(message) {
            const notification = document.getElementById('successNotification');
            const messageElement = document.getElementById('notificationMessage');
            
            messageElement.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Reject order function (ENHANCED)
        async function rejectOrder(orderId, orderDbId) {
            if (!confirm('Are you sure you want to reject this order? This action cannot be undone.')) {
                return;
            }

            try {
                const rejectionReason = prompt('Please provide a reason for rejection:');
                if (!rejectionReason) return;

                const { error } = await supabase
                    .from('orders')
                    .update({
                        status: 'cancelled',
                        admin_notes: `Rejected by admin: ${rejectionReason}`,
                        cancelled_at: new Date().toISOString(),
                        cancelled_by: currentUserDetails?.id
                    })
                    .eq('id', orderDbId);

                if (error) {
                    throw new Error('Failed to reject order: ' + error.message);
                }

                // Send rejection notification to customer
                await sendRejectionNotification(orderId, rejectionReason);

                showSuccessNotification('Order has been rejected and customer will be notified.');
                await loadAdminApprovalOrders();

            } catch (error) {
                console.error('Error rejecting order:', error);
                alert('Error rejecting order: ' + error.message);
            }
        }

        // Send rejection notification
        async function sendRejectionNotification(orderId, reason) {
            try {
                const { data: order, error } = await supabase
                    .from('orders')
                    .select('customer_phone, customers(phone)')
                    .eq('order_id', orderId)
                    .single();

                if (error || !order) return;

                const customerPhone = order.customers?.phone || order.customer_phone;
                if (!customerPhone) return;

                const rejectionMessage = `❌ *Order ${orderId} Rejected*

We regret to inform you that your order has been rejected.

📝 *Reason:* ${reason}

💰 *Refund Information:*
If payment was made, a full refund will be processed within 3-5 business days.

🛒 *Place a New Order:*
You can place a new order anytime at:
https://autolab-user.vercel.app/catalog.html

📞 *Need Assistance?*
Contact our customer service for any questions.

We apologize for any inconvenience caused.

AutoLab Team 🚗`;

                const payload = {
                    messages: [{
                        from: customerPhone,
                        text: { body: rejectionMessage }
                    }],
                    _metadata: {
                        source: 'admin_rejection',
                        timestamp: new Date().toISOString(),
                        order_id: orderId,
                        rejected_by: currentUserDetails?.id
                    }
                };

                await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

            } catch (error) {
                console.error('Error sending rejection notification:', error);
            }
        }

        // Initialize page
        async function initializePage() {
            try {
                const user = await checkAuth();
                if (!user) return;

                const userDetails = await getUserDetails(user.id);
                if (!userDetails) {
                    console.error('Unable to load user details');
                    logout();
                    return;
                }

                updateUserInterface(userDetails);
                
                // Load initial data for the active tab
                await loadTabData('admin-approval');
                
                setupEventListeners();

            } catch (err) {
                console.error('Error initializing page:', err);
                alert('Error loading page. Please try again.');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('userAvatar').addEventListener('click', toggleDropdown);

            document.addEventListener('click', function (e) {
                const dropdown = document.getElementById('userDropdown');
                const avatar = document.getElementById('userAvatar');

                if (!avatar.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });

            document.getElementById('logoutButton').addEventListener('click', logout);
        }

        // Make functions available globally
        window.rejectOrder = rejectOrder;

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializePage();
        });
    </script>
</body>
</html>