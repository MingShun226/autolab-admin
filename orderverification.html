<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Order Verification - AutoLab</title>
    <style>
        :root {
            --primary-color: #52c41a;
            --secondary-color: #1890ff;
            --tertiary-color: #fa8c16;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --error-color: #f5222d;
            --info-color: #1890ff;
            --background-color: #f0f2f5;
            --sidebar-width: 225px;
            --header-height: 60px;
            --text-color: #333;
            --text-light: #666;
            --border-radius: 4px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #222;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
        }

        /* Logo Section */
        .logo-container {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #333;
            height: var(--header-height);
        }

        .logo {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .logo-text {
            font-size: 20px;
            font-weight: bold;
        }

        /* Navigation Menu */
        .nav-menu {
            display: flex;
            flex-direction: column;
            padding: 10px 0;
            flex-grow: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #ddd;
            text-decoration: none;
            transition: all 0.3s;
            gap: 12px;
        }

        .nav-item:hover {
            background-color: #333;
        }

        .nav-item.active {
            background-color: #e21b1b;
            color: white;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-item.sub-item {
            padding-left: 40px;
            position: relative;
            background-color: rgba(0, 0, 0, 0.1);
            border-left: 3px solid transparent;
        }

        .nav-item.sub-item::before {
            content: '';
            position: absolute;
            left: 23px;
            top: 0;
            height: 100%;
            width: 1px;
            background-color: #444;
        }

        .nav-item.sub-item .sub-icon {
            margin-left: -12px;
        }

        /* Active sub-item styling */
        .nav-item.sub-item.active {
            background-color: #e21b1b;
            border-left: 3px solid #fff;
        }

        .nav-item.sub-item:hover {
            background-color: #333;
            border-left: 3px solid #888;
        }

        .nav-item.sub-item.active:hover {
            background-color: #c91818;
            border-left: 3px solid #fff;
        }

        .nav-text {
            font-size: 14px;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
        }

        .header {
            height: var(--header-height);
            background-color: white;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            position: sticky;
            top: 0;
            z-index: 99;
        }

        .header-right {
            display: flex;
            align-items: center;
        }

        /* Content Container */
        .content {
            padding: 24px;
        }

        .page-title {
            font-size: 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .button {
            padding: 8px 16px;
            border-radius: var(--border-radius);
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .button.primary {
            background-color: var(--primary-color);
            color: white;
        }

        .button.primary:hover {
            background-color: #3fa00c;
        }

        .button.secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .button.secondary:hover {
            background-color: #096dd9;
        }

        .button.tertiary {
            background-color: var(--tertiary-color);
            color: white;
        }

        .button.tertiary:hover {
            background-color: #d87205;
        }

        .button.outline {
            background-color: white;
            color: var(--text-color);
            border: 1px solid #d9d9d9;
        }

        .button.outline:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .button .icon {
            margin-right: 8px;
        }

        /* Panel Styles */
        .panel {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 24px;
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 500;
        }

        .panel-content {
            padding: 20px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #f0f0f0;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary-color);
        }

        .tab-badge {
            display: inline-block;
            background-color: #f5f5f5;
            color: var(--text-light);
            border-radius: 10px;
            padding: 0 8px;
            font-size: 12px;
            margin-left: 8px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: bold;
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
        }

        .dropdown-menu {
            position: absolute;
            top: 45px;
            right: -60px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            min-width: 200px;
            display: none;
            z-index: 100;
        }

        .dropdown-menu.active {
            display: block;
        }

        .dropdown-item {
            padding: 8px 16px;
            display: block;
            color: var(--text-color);
        }

        .dropdown-divider {
            height: 1px;
            background-color: #eee;
            margin: 8px 0;
        }

        .dropdown-item.logout {
            color: #e21b1b;
            cursor: pointer;
        }

        .dropdown-item.logout:hover {
            background-color: #f8f8f8;
        }

        .page-title {
            font-size: 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .order-card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #f0f0f0;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .order-id {
            font-size: 18px;
            font-weight: 600;
        }

        .order-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .order-details {
            display: none;
            margin-top: 15px;
            border-top: 1px solid #e0e0e0;
            padding-top: 15px;
        }

        .order-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .meta-item .meta-label {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .meta-item .meta-value {
            font-size: 15px;
            font-weight: 500;
        }

        .status-processing {
            background: #fff3cd;
            color: #856404;
        }

        .status-payment-submitted {
            background: #e3f2fd;
            color: #0d47a1;
        }

        .approval-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .payment-verification-form {
            background: #e8f5e8;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #c8e6c9;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-approve {
            background: #28a745;
            color: white;
        }

        .btn-approve:hover {
            background: #218838;
        }

        .btn-verify {
            background: #007bff;
            color: white;
        }

        .btn-verify:hover {
            background: #0056b3;
        }

        .btn-reject {
            background: #dc3545;
            color: white;
        }

        .btn-reject:hover {
            background: #c82333;
        }

        .empty-state {
            text-align: center;
            color: #6c757d;
            padding: 60px 20px;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .priority-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .priority-urgent { background: #dc3545; }
        .priority-high { background: #fd7e14; }
        .priority-normal { background: #28a745; }
        .priority-low { background: #6c757d; }

        .time-badge {
            background: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .driver-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .btn-delete-small {
            background-color: transparent;
            color: var(--error-color);
            border: 1px solid var(--error-color);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            padding: 0;
            flex-shrink: 0;
            font-size: 14px;
        }

        .btn-delete-small:hover {
            background-color: var(--error-color);
            color: white;
        }

        /* Loading indicator */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        .success-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }

        .success-notification.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toggle-indicator {
            font-size: 12px;
            margin-left: 8px;
            transition: transform 0.3s;
        }

        .order-header.expanded .toggle-indicator {
            transform: rotate(180deg);
        }

        .order-product-details {
            margin-top: 15px;
            border-top: 1px solid #e0e0e0;
            padding-top: 15px;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .items-table th {
            text-align: left;
            padding: 10px;
            background-color: #f7f7f7;
            border-bottom: 1px solid #e9ecef;
            font-weight: 500;
            font-size: 13px;
        }

        .items-table td {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }

        .payment-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #007bff;
        }

        .payment-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #0d47a1;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }

        .badge-danger {
            background: #fff2f0;
            color: #f5222d;
            border: 1px solid #ffccc7;
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- Sidebar Menu -->
        <div class="sidebar">
            <div class="logo-container">
                <svg class="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6Z" />
                </svg>
                <div class="logo-text">Autolabs</div>
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </div>
                    <div class="nav-text">Admin Dashboard</div>
                </a>
                <a href="order.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                        </svg>
                    </div>
                    <div class="nav-text">Order Page</div>
                </a>
                <a href="orderverification.html" class="nav-item sub-item active">
                    <div class="nav-icon sub-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                    <div class="nav-text">Orders Verification</div>
                </a>
                <a href="orderwarehouse.html" class="nav-item sub-item">
                    <div class="nav-icon sub-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 12h-6l-2 3h-4l-2-3H2"></path>
                            <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path>
                        </svg>
                    </div>
                    <div class="nav-text">Warehouse Operations</div>
                </a>
                <a href="stock.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                        </svg>
                    </div>
                    <div class="nav-text">Inventory Page</div>
                </a>

                <a href="routemanagement.html" class="nav-item active">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                    </div>
                    <div class="nav-text">Route Management</div>
                </a>

                <a href="customer.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="nav-text">Customer Page</div>
                </a>
                <a href="staff.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="nav-text">Staff Page</div>
                </a>
                <a href="reports.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                    </div>
                    <div class="nav-text">Reports Page</div>
                </a>
                <a href="communication center page.html" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                        </svg>
                    </div>
                    <div class="nav-text">Communication Center</div>
                </a>
                <a href="#" class="nav-item">
                    <div class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </div>
                    <div class="nav-text">Settings Page</div>
                </a>
            </div>
        </div>

        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">
                        AD
                    </div>
                    <div>
                        <div style="font-weight: 500;" id="userName">Admin User</div>
                        <div style="font-size: 12px; color: var(--text-light);">Administrator</div>
                    </div>
                    <!-- Dropdown menu -->
                    <div class="dropdown-menu" id="userDropdown">
                        <div class="dropdown-item" id="userFullName">Admin User</div>
                        <div class="dropdown-item" id="userStaffId">Staff ID: 8888</div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item logout" id="logoutButton">Logout</div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="content">
                <div class="page-title">
                    <span>WhatsApp Order Workflow Management</span>
                </div>

                <div class="panel">
                    <div class="tabs" id="statusTabs">
                        <div class="tab" data-tab="awaiting">
                            üì± Awaiting WhatsApp Confirmation
                            <span class="tab-badge" id="awaiting-count">0</span>
                        </div>
                        <div class="tab" data-tab="confirmed">
                            üí≥ Confirmed - Pending Payment
                            <span class="tab-badge" id="confirmed-count">0</span>
                        </div>
                        <div class="tab" data-tab="payment-submitted">
                            üí∞ Payment Submitted
                            <span class="tab-badge" id="payment-submitted-count">0</span>
                        </div>
                        <div class="tab active" data-tab="admin-approval">
                            ‚è≥ Pending Admin Approval
                            <span class="tab-badge" id="approval-count">0</span>
                        </div>
                        <div class="tab" data-tab="approved">
                            ‚úÖ Approved & Processing
                            <span class="tab-badge" id="approved-count">0</span>
                        </div>
                    </div>

                    <div class="panel-content">
                        <!-- Awaiting WhatsApp Confirmation Tab -->
                        <div class="tab-panel" id="awaiting-panel">
                            <div id="awaiting-orders-container">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <span>Loading awaiting confirmation orders...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Confirmed - Pending Payment Tab -->
                        <div class="tab-panel" id="confirmed-panel">
                            <div id="confirmed-orders-container">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <span>Loading confirmed orders...</span>
                                </div>
                            </div>
                        </div>

                        <!-- NEW: Payment Submitted Tab -->
                        <div class="tab-panel" id="payment-submitted-panel">
                            <div id="payment-submitted-orders-container">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <span>Loading payment submitted orders...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Pending Admin Approval Tab -->
                        <div class="tab-panel active" id="admin-approval-panel">
                            <div id="approval-orders-container">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <span>Loading orders pending approval...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Approved & Processing Tab -->
                        <div class="tab-panel" id="approved-panel">
                            <div id="approved-orders-container">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <span>Loading approved orders...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success notification -->
    <div class="success-notification" id="successNotification">
        <i class="fas fa-check-circle" style="margin-right: 10px;"></i>
        <span id="notificationMessage">Action completed successfully!</span>
    </div>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://bbwimjvqpyxwhovihtfm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJid2ltanZxcHl4d2hvdmlodGZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MjAwMDksImV4cCI6MjA2MDk5NjAwOX0._D3wackPNKg-IbiswH7M-3wqeQRP6ujMmcJ9bb7_1z0';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // n8n Webhook Configuration for approval notifications
        const N8N_WEBHOOK_URL = 'https://apipietech.app.n8n.cloud/webhook/unified-whatsapp';
        const N8N_ADMIN_VERIFICATION_WEBHOOK = 'https://apipietech.app.n8n.cloud/webhook/admin-verification';

        // Global variables
        let currentUserDetails = null;
        let allStaff = [];
        let orderCounts = {
            awaiting: 0,
            confirmed: 0,
            paymentSubmitted: 0,
            approval: 0,
            approved: 0
        };

        // Available drivers data
        const availableDrivers = [
            { id: 'driver1', name: 'Ahmad Rahman', phone: '0123456789', status: 'available' },
            { id: 'driver2', name: 'Siti Nurhaliza', phone: '0123456788', status: 'available' },
            { id: 'driver3', name: 'Mohammad Zainal', phone: '0123456787', status: 'busy' },
            { id: 'driver4', name: 'Fatimah Ali', phone: '0123456786', status: 'available' },
            { id: 'lalamove', name: 'Lalamove (External)', phone: 'External', status: 'available' }
        ];

        // Helper functions for enhanced notifications
        function showErrorMessage(message) {
            // Create and show error notification
            const notification = document.createElement('div');
            notification.className = 'alert alert-danger';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #dc3545;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                max-width: 400px;
            `;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            // Auto-hide after 8 seconds
            setTimeout(() => notification.remove(), 8000);
        }

        function showWarningMessage(message) {
            // Create and show warning notification
            const notification = document.createElement('div');
            notification.className = 'alert alert-warning';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ffc107;
                color: #212529;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                max-width: 400px;
            `;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            // Auto-hide after 6 seconds
            setTimeout(() => notification.remove(), 6000);
        }

        // Helper function to update order status UI
        function updateOrderStatusUI(orderDbId, status) {
            const orderCard = document.getElementById(`order-card-${orderDbId}`);
            if (!orderCard) return;
            
            const statusElement = orderCard.querySelector('.order-status');
            const actionButtons = orderCard.querySelector('.action-buttons');
            
            if (status === 'verified') {
                if (statusElement) {
                    statusElement.innerHTML = '‚úÖ Payment Verified';
                    statusElement.className = 'order-status';
                    statusElement.style.color = '#52c41a';
                    statusElement.style.background = '#f6ffed';
                    statusElement.style.border = '1px solid #b7eb8f';
                }
                if (actionButtons) {
                    actionButtons.innerHTML = '<span class="badge badge-success">‚úÖ Verified & Approved</span>';
                }
            } else if (status === 'rejected') {
                if (statusElement) {
                    statusElement.innerHTML = '‚ùå Payment Rejected';
                    statusElement.className = 'order-status';
                    statusElement.style.color = '#f5222d';
                    statusElement.style.background = '#fff2f0';
                    statusElement.style.border = '1px solid #ffccc7';
                }
                if (actionButtons) {
                    actionButtons.innerHTML = '<span class="badge badge-danger">‚ùå Payment Rejected</span>';
                }
            }
        }

        // Check if user is authenticated
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = 'admin-login.html';
                return null;
            }
            return user;
        }

        // Get user details from database
        async function getUserDetails(userId) {
            const { data, error } = await supabase
                .from('staff_members')
                .select('*')
                .eq('id', userId)
                .single();

            if (error) {
                console.error('Error fetching user details:', error);
                return null;
            }
            return data;
        }

        // Update user interface with user details
        function updateUserInterface(userData) {
            currentUserDetails = userData;
            const initials = userData.first_name.charAt(0) + userData.last_name.charAt(0);
            document.getElementById('userAvatar').textContent = initials;
            document.getElementById('userName').textContent = `${userData.first_name} ${userData.last_name}`;
            document.getElementById('userFullName').textContent = `${userData.first_name} ${userData.last_name}`;
            document.getElementById('userStaffId').textContent = `Staff ID: ${userData.staff_id}`;
        }

        // Handle logout
        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Error signing out:', error);
                alert('Error signing out. Please try again.');
            } else {
                sessionStorage.removeItem('currentUser');
                window.location.href = 'admin-login.html';
            }
        }

        // Toggle dropdown menu
        function toggleDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('active');
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active class from all tabs and panels
                document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding panel
                btn.classList.add('active');
                const tabId = btn.dataset.tab + '-panel';
                document.getElementById(tabId).classList.add('active');
                
                // Load data for the selected tab
                loadTabData(btn.dataset.tab);
            });
        });

        // Load orders for specific tab
        async function loadTabData(tab) {
            try {
                switch(tab) {
                    case 'awaiting':
                        await loadAwaitingOrders();
                        break;
                    case 'confirmed':
                        await loadConfirmedOrders();
                        break;
                    case 'payment-submitted':
                        await loadPaymentSubmittedOrders();
                        break;
                    case 'admin-approval':
                        await loadAdminApprovalOrders();
                        break;
                    case 'approved':
                        await loadApprovedOrders();
                        break;
                }
            } catch (error) {
                console.error(`Error loading ${tab} orders:`, error);
            }
        }

        // Load orders awaiting WhatsApp confirmation
        async function loadAwaitingOrders() {
            const container = document.getElementById('awaiting-orders-container');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>Loading awaiting confirmation orders...</span>
                </div>
            `;

            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*, customers(name)')
                    .eq('status', 'awaiting_confirmation')
                    .order('order_date', { ascending: false });

                if (error) throw error;

                orderCounts.awaiting = orders?.length || 0;
                document.getElementById('awaiting-count').textContent = orderCounts.awaiting;

                if (!orders || orders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-hourglass-half"></i>
                            <h3>No Orders Awaiting Confirmation</h3>
                            <p>Orders will appear here when customers haven't confirmed via WhatsApp yet.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = orders.map(order => createSimpleOrderCard(order, 'awaiting')).join('');
            } catch (error) {
                console.error('Error loading awaiting orders:', error);
                container.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading orders</p></div>`;
            }
        }

        // Load orders confirmed but pending payment
        async function loadConfirmedOrders() {
            const container = document.getElementById('confirmed-orders-container');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>Loading confirmed orders...</span>
                </div>
            `;

            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*, customers(name)')
                    .eq('status', 'pending_payment')
                    .order('confirmed_at', { ascending: false });

                if (error) throw error;

                orderCounts.confirmed = orders?.length || 0;
                document.getElementById('confirmed-count').textContent = orderCounts.confirmed;

                if (!orders || orders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-credit-card"></i>
                            <h3>No Orders Pending Payment</h3>
                            <p>Confirmed orders awaiting payment will appear here.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = orders.map(order => createSimpleOrderCard(order, 'confirmed')).join('');
            } catch (error) {
                console.error('Error loading confirmed orders:', error);
                container.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading orders</p></div>`;
            }
        }

        // NEW: Load orders with payment submitted (awaiting verification)
        async function loadPaymentSubmittedOrders() {
            const container = document.getElementById('payment-submitted-orders-container');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>Loading payment submitted orders...</span>
                </div>
            `;

            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*, customers(name)')
                    .eq('status', 'payment_submitted')
                    .order('payment_verified_at', { ascending: false });

                if (error) throw error;

                orderCounts.paymentSubmitted = orders?.length || 0;
                document.getElementById('payment-submitted-count').textContent = orderCounts.paymentSubmitted;

                if (!orders || orders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-credit-card"></i>
                            <h3>No Payment Submitted Orders</h3>
                            <p>Orders with submitted payments awaiting verification will appear here.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = orders.map(order => createPaymentVerificationCard(order)).join('');
            } catch (error) {
                console.error('Error loading payment submitted orders:', error);
                container.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading orders</p></div>`;
            }
        }

        // Load orders needing admin approval (payment verified)
        async function loadAdminApprovalOrders() {
            const container = document.getElementById('approval-orders-container');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>Loading orders pending approval...</span>
                </div>
            `;

            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*, customers(name)')
                    .eq('status', 'pending_confirmation')
                    .order('payment_verified_at', { ascending: false });

                if (error) throw error;

                orderCounts.approval = orders?.length || 0;
                document.getElementById('approval-count').textContent = orderCounts.approval;

                if (!orders || orders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <h3>No Orders Need Admin Approval</h3>
                            <p>All verified payment orders have been processed or there are no verified orders.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = orders.map(order => createOrderApprovalCard(order)).join('');
            } catch (error) {
                console.error('Error loading approval orders:', error);
                container.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading orders</p></div>`;
            }
        }

        // Load approved orders
        async function loadApprovedOrders() {
            const container = document.getElementById('approved-orders-container');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>Loading approved orders...</span>
                </div>
            `;

            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*, customers(name)')
                    .eq('status', 'processing')
                    .order('approved_at', { ascending: false });

                if (error) throw error;

                orderCounts.approved = orders?.length || 0;
                document.getElementById('approved-count').textContent = orderCounts.approved;

                if (!orders || orders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-truck"></i>
                            <h3>No Approved Orders</h3>
                            <p>Approved orders ready for delivery will appear here.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = orders.map(order => createDetailedApprovedOrderCard(order)).join('');
            } catch (error) {
                console.error('Error loading approved orders:', error);
                container.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading orders</p></div>`;
            }
        }
        
        // NEW: Create payment verification card
        function createPaymentVerificationCard(order) {
            const customerName = order.customers ? order.customers.name : 'Unknown Customer';
            const paymentDate = order.payment_verified_at ? new Date(order.payment_verified_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : 'Just submitted';

            const hoursWaiting = order.payment_verified_at ? 
                Math.round((new Date() - new Date(order.payment_verified_at)) / (1000 * 60 * 60)) : 0;

            return `
                <div class="order-card" id="order-card-${order.id}">
                    <div class="order-header" onclick="toggleOrderDetails('${order.id}')">
                        <div>
                            <div class="order-id">
                                üí∞ ${order.order_id}
                                <span class="payment-badge">Payment Submitted</span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="order-status status-payment-submitted">Payment Verification Required</div>
                            <button class="btn-delete-small" onclick="deleteOrder(event, '${order.id}', '${order.order_id}')" title="Delete Order">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            <span class="toggle-indicator">‚ñº</span>
                        </div>
                    </div>
                    
                    <div class="order-details" id="details-${order.id}" style="display: none;">
                        <div class="order-meta">
                            <div class="meta-item">
                                <div class="meta-label">Payment Submitted</div>
                                <div class="meta-value">${paymentDate} (${hoursWaiting}h ago)</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Customer</div>
                                <div class="meta-value">${customerName}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Phone</div>
                                <div class="meta-value">${order.customer_phone || 'N/A'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Address</div>
                                <div class="meta-value">${order.address || 'Address not provided'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Amount</div>
                                <div class="meta-value">RM ${parseFloat(order.amount || 0).toFixed(2)}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Delivery Method</div>
                                <div class="meta-value">${order.driver || 'Not specified'}</div>
                            </div>
                        </div>

                        ${order.payment_notes ? `
                            <div class="payment-info">
                                <h4><i class="fas fa-sticky-note"></i> Customer Payment Notes</h4>
                                <p>${order.payment_notes}</p>
                            </div>
                        ` : ''}

                        <div id="product-details-container-${order.id}" style="margin-top: 15px;"></div>

                        <div class="payment-verification-form">
                            <h4><i class="fas fa-credit-card"></i> Payment Verification</h4>
                            
                            <form class="payment-verification-form-content" data-order-id="${order.order_id}" data-order-db-id="${order.id}">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="payment-method-${order.order_id}">
                                            <i class="fas fa-credit-card"></i> Payment Method Used
                                        </label>
                                        <select id="payment-method-${order.order_id}" name="payment_method">
                                            <option value="">Select Payment Method</option>
                                            <option value="online_banking">Online Banking</option>
                                            <option value="qr_code">QR Code (DuitNow)</option>
                                            <option value="ewallet">Touch 'n Go eWallet</option>
                                            <option value="grabpay">GrabPay</option>
                                            <option value="cash">Cash Payment</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="payment-reference-${order.order_id}">
                                            <i class="fas fa-hashtag"></i> Payment Reference Number
                                        </label>
                                        <input type="text" id="payment-reference-${order.order_id}" 
                                               name="payment_reference" 
                                               placeholder="Transaction/Reference number">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="verification-notes-${order.order_id}">
                                        <i class="fas fa-clipboard-check"></i> Verification Notes
                                    </label>
                                    <textarea id="verification-notes-${order.order_id}" 
                                              name="verification_notes" 
                                              placeholder="Any notes about the payment verification process"></textarea>
                                </div>
                                
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-reject" onclick="rejectPaymentWithWebhook('${order.order_id}', '${order.id}')">
                                        <i class="fas fa-times"></i> Reject Payment
                                    </button>
                                    <button type="button" class="btn btn-verify" onclick="verifyPaymentWithWebhook('${order.order_id}', '${order.id}')">
                                        <i class="fas fa-check"></i> Verify & Approve Payment
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        // Enhanced verify payment function with webhook integration
        async function verifyPaymentWithWebhook(orderId, orderDbId) {
            const form = document.querySelector(`[data-order-id="${orderId}"]`);
            const paymentMethod = form.querySelector(`#payment-method-${orderId}`).value;
            const referenceNumber = form.querySelector(`#payment-reference-${orderId}`).value;
            const notes = form.querySelector(`#verification-notes-${orderId}`).value;
            
            // Validate required fields
            if (!paymentMethod) {
                showErrorMessage('Please select a payment method');
                return false;
            }
            
            // Show loading state
            const verifyBtn = form.querySelector('.btn-verify');
            const rejectBtn = form.querySelector('.btn-reject');
            const originalText = verifyBtn.innerHTML;
            
            verifyBtn.disabled = true;
            rejectBtn.disabled = true;
            verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
            
            try {
                // 1. Update database first (your existing logic)
                const verificationData = {
                    payment_method: paymentMethod,
                    payment_reference: referenceNumber,
                    payment_verified_at: new Date().toISOString(),
                    payment_verified_by: currentUserDetails?.id,
                    status: 'pending_confirmation',
                    admin_notes: notes
                };
                
                const { error: updateError } = await supabase
                    .from('orders')
                    .update(verificationData)
                    .eq('id', orderDbId);
                
                if (updateError) {
                    throw new Error('Failed to verify payment: ' + updateError.message);
                }
                
                // 2. Send webhook notification to n8n
                try {
                    const webhookResponse = await fetch(N8N_ADMIN_VERIFICATION_WEBHOOK, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'verify',
                            orderId: orderId,
                            adminId: currentUserDetails?.id || 'admin123',
                            paymentMethod: paymentMethod,
                            referenceNumber: referenceNumber,
                            notes: notes,
                            timestamp: new Date().toISOString(),
                            _metadata: {
                                source: 'admin_verification',
                                admin_name: currentUserDetails ? `${currentUserDetails.first_name} ${currentUserDetails.last_name}` : 'Admin User'
                            }
                        })
                    });
                    
                    const webhookResult = await webhookResponse.json().catch(() => ({}));
                    
                    if (!webhookResponse.ok) {
                        console.warn('Webhook notification failed, but database update succeeded');
                    }
                } catch (webhookError) {
                    console.warn('Webhook error (non-critical):', webhookError);
                    // Don't throw - database update succeeded
                }
                
                // 3. Update UI
                showSuccessNotification('‚úÖ Payment verified successfully! Customer has been notified.');
                
                // Hide verification form and show verified badge
                updateOrderStatusUI(orderDbId, 'verified');
                
                // 4. Refresh data
                await loadPaymentSubmittedOrders();
                await loadAdminApprovalOrders();
                await loadAllOrderCounts();
                
                return true;
                
            } catch (error) {
                console.error('Error verifying payment:', error);
                showErrorMessage('‚ùå Error verifying payment: ' + error.message);
                
                // Reset button state
                verifyBtn.disabled = false;
                rejectBtn.disabled = false;
                verifyBtn.innerHTML = originalText;
                
                return false;
            }
        }

        // Enhanced reject payment function with webhook integration
        async function rejectPaymentWithWebhook(orderId, orderDbId) {
            const form = document.querySelector(`[data-order-id="${orderId}"]`);
            const notes = form.querySelector(`#verification-notes-${orderId}`).value;
            
            // Confirm rejection
            if (!confirm('Are you sure you want to reject this payment? The customer will be notified.')) {
                return false;
            }
            
            // Show loading state
            const verifyBtn = form.querySelector('.btn-verify');
            const rejectBtn = form.querySelector('.btn-reject');
            const originalText = rejectBtn.innerHTML;
            
            verifyBtn.disabled = true;
            rejectBtn.disabled = true;
            rejectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rejecting...';
            
            try {
                // 1. Update database first
                const { error: updateError } = await supabase
                    .from('orders')
                    .update({
                        status: 'pending_payment',
                        admin_notes: `Payment rejected by admin: ${notes}`,
                        payment_verified_at: null,
                        payment_verified_by: null
                    })
                    .eq('id', orderDbId);
                
                if (updateError) {
                    throw new Error('Failed to reject payment: ' + updateError.message);
                }
                
                // 2. Send webhook notification to n8n
                try {
                    const webhookResponse = await fetch(N8N_ADMIN_VERIFICATION_WEBHOOK, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'reject',
                            orderId: orderId,
                            adminId: currentUserDetails?.id || 'admin123',
                            notes: notes,
                            timestamp: new Date().toISOString(),
                            _metadata: {
                                source: 'admin_verification',
                                admin_name: currentUserDetails ? `${currentUserDetails.first_name} ${currentUserDetails.last_name}` : 'Admin User'
                            }
                        })
                    });
                    
                    if (!webhookResponse.ok) {
                        console.warn('Webhook notification failed, but database update succeeded');
                    }
                } catch (webhookError) {
                    console.warn('Webhook error (non-critical):', webhookError);
                }
                
                // 3. Update UI
                showWarningMessage('‚ùå Payment rejected. Customer has been notified.');
                
                updateOrderStatusUI(orderDbId, 'rejected');
                
                // 4. Refresh data  
                await loadPaymentSubmittedOrders();
                await loadConfirmedOrders();
                await loadAllOrderCounts();
                
                return true;
                
            } catch (error) {
                console.error('Error rejecting payment:', error);
                showErrorMessage('‚ùå Error rejecting payment: ' + error.message);
                
                // Reset button state
                verifyBtn.disabled = false;
                rejectBtn.disabled = false;
                rejectBtn.innerHTML = originalText;
                
                return false;
            }
        }

        // Handle form submission (only for order approval now)
        document.addEventListener('submit', async (e) => {

            // Handle order approval form submission (existing functionality)
            if (e.target.classList.contains('approval-form-content')) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const orderId = e.target.dataset.orderId;
                const orderDbId = e.target.dataset.orderDbId;
                
                const submitButton = e.target.querySelector('.btn-approve');
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                submitButton.disabled = true;
                
                try {
                    // Prepare approval data
                    const approvalData = {
                        assigned_driver: formData.get('assigned_driver'),
                        estimated_delivery_date: formData.get('estimated_delivery_date'),
                        estimated_delivery_time: formData.get('estimated_delivery_time'),
                        processing_priority: formData.get('processing_priority'),
                        requires_installation: formData.get('requires_installation') === 'true',
                        preparation_hours: parseInt(formData.get('preparation_hours')),
                        delivery_instructions: formData.get('delivery_instructions'),
                        installation_instructions: formData.get('installation_instructions'),
                        admin_notes: formData.get('admin_notes'),
                        status: 'processing',
                        approved_at: new Date().toISOString(),
                        approved_by: currentUserDetails?.id
                    };
                    
                    // Update order in database
                    const { error: updateError } = await supabase
                        .from('orders')
                        .update(approvalData)
                        .eq('id', orderDbId);
                    
                    if (updateError) {
                        throw new Error('Failed to update order: ' + updateError.message);
                    }
                    
                    // Send detailed WhatsApp notification (reusing existing function)
                    const { data: fullOrder, error: orderError } = await supabase
                        .from('orders')
                        .select('*, customers(name, phone)')
                        .eq('id', orderDbId)
                        .single();
                    
                    if (!orderError && fullOrder) {
                        await sendDetailedApprovalNotification(fullOrder, approvalData);
                    }
                    
                    showSuccessNotification('Order approved successfully! Customer has been notified via WhatsApp.');
                    
                    // Refresh the approval orders list
                    await loadAdminApprovalOrders();
                    
                    // Also refresh approved orders to show the newly approved order
                    await loadApprovedOrders();
                    
                    // Refresh all counts
                    await loadAllOrderCounts();
                    
                } catch (error) {
                    console.error('Error approving order:', error);
                    alert('Error approving order: ' + error.message);
                    
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                }
            }
        });



        // Create simple order card for display-only tabs
        function createSimpleOrderCard(order, type) {
            const customerName = order.customers ? order.customers.name : 'Unknown Customer';
            const orderDate = new Date(order.order_date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const statusConfig = {
                'awaiting': { icon: 'üì±', text: 'Awaiting WhatsApp Confirmation', color: '#fa8c16' },
                'confirmed': { icon: 'üí≥', text: 'Confirmed - Pending Payment', color: '#1890ff' },
                'approved': { icon: '‚öôÔ∏è', text: 'Processing', color: '#52c41a' }
            };

            const status = statusConfig[type] || statusConfig['awaiting'];

            return `
                <div class="order-card" id="order-card-${order.id}">
                    <div class="order-header" onclick="toggleOrderDetails('${order.id}')">
                        <div>
                            <div class="order-id">${status.icon} ${order.order_id}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="order-status" style="color: ${status.color};">${status.text}</div>
                             <button class="btn-delete-small" onclick="deleteOrder(event, '${order.id}', '${order.order_id}')" title="Delete Order">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                             <span class="toggle-indicator">‚ñº</span>
                        </div>
                    </div>
                    
                    <div class="order-details" id="details-${order.id}" style="display: none;">
                        <div class="order-meta">
                             <div class="meta-item">
                                <div class="meta-label">Placed</div>
                                <div class="meta-value">${orderDate}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Customer</div>
                                <div class="meta-value">${customerName}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Phone</div>
                                <div class="meta-value">${order.customer_phone || 'N/A'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Address</div>
                                <div class="meta-value">${order.address || 'Address not provided'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Amount</div>
                                <div class="meta-value">RM ${parseFloat(order.amount || 0).toFixed(2)}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Delivery Method</div>
                                <div class="meta-value">${order.driver || 'Not specified'}</div>
                            </div>
                        </div>
                        <div id="product-details-container-${order.id}" style="margin-top: 15px;"></div>
                    </div>
                </div>
            `;
        }

        // Create detailed order approval card (existing functionality)
        function createOrderApprovalCard(order) {
            const customerName = order.customers ? order.customers.name : 'Unknown Customer';
            const orderDate = new Date(order.order_date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const verifiedDate = order.payment_verified_at ? new Date(order.payment_verified_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : 'Recently verified';

            const hoursWaiting = order.payment_verified_at ? 
                Math.round((new Date() - new Date(order.payment_verified_at)) / (1000 * 60 * 60)) : 0;

            // Set default delivery date (tomorrow)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const defaultDeliveryDate = tomorrow.toISOString().split('T')[0];

            return `
                <div class="order-card" id="order-card-${order.id}">
                     <div class="order-header" onclick="toggleOrderDetails('${order.id}')">
                        <div>
                            <div class="order-id">
                                <span class="priority-indicator priority-${order.is_urgent ? 'urgent' : 'normal'}"></span>
                                ${order.order_id}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="order-status status-processing">‚è≥ Pending Admin Approval</div>
                            <button class="btn-delete-small" onclick="deleteOrder(event, '${order.id}', '${order.order_id}')" title="Delete Order">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            <span class="toggle-indicator">‚ñº</span>
                        </div>
                    </div>
                    
                    <div class="order-details" id="details-${order.id}" style="display: none;">
                         <div class="order-meta">
                             <div class="meta-item">
                                <div class="meta-label">Payment Verified</div>
                                <div class="meta-value">${verifiedDate} (${hoursWaiting}h ago)</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Customer</div>
                                <div class="meta-value">${customerName}</div>
                            </div>
                             <div class="meta-item">
                                <div class="meta-label">Phone</div>
                                <div class="meta-value">${order.customer_phone || 'N/A'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Address</div>
                                <div class="meta-value">${order.address || 'Address not provided'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Amount</div>
                                <div class="meta-value">RM ${parseFloat(order.amount || 0).toFixed(2)}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Delivery Method</div>
                                <div class="meta-value">${order.driver || 'Not specified'}</div>
                            </div>
                        </div>
                        <div id="product-details-container-${order.id}" style="margin-top: 15px;"></div>
                        <div class="approval-form">
                            <h4><i class="fas fa-cog"></i> Order Processing Details</h4>
                            
                            <form class="approval-form-content" data-order-id="${order.order_id}" data-order-db-id="${order.id}">
                                <div class="form-grid">
                                    <!-- Driver Assignment -->
                                    <div class="form-group">
                                        <label for="driver-${order.order_id}">
                                            <i class="fas fa-user-tie"></i> Assign Driver
                                        </label>
                                        <select id="driver-${order.order_id}" name="assigned_driver" required>
                                            <option value="">Select Driver</option>
                                            ${availableDrivers.map(driver => `
                                                <option value="${driver.name}" ${driver.status === 'busy' ? 'disabled' : ''}>
                                                    ${driver.name} - ${driver.phone} 
                                                    ${driver.status === 'busy' ? '(Busy)' : '(Available)'}
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    
                                    <!-- Delivery Date -->
                                    <div class="form-group">
                                        <label for="delivery-date-${order.order_id}">
                                            <i class="fas fa-calendar"></i> Delivery Date
                                        </label>
                                        <input type="date" id="delivery-date-${order.order_id}" 
                                               name="estimated_delivery_date" required
                                               value="${defaultDeliveryDate}"
                                               min="${new Date().toISOString().split('T')[0]}">
                                    </div>
                                    
                                    <!-- Delivery Time -->
                                    <div class="form-group">
                                        <label for="delivery-time-${order.order_id}">
                                            <i class="fas fa-clock"></i> Estimated Arrival Time
                                        </label>
                                        <input type="time" id="delivery-time-${order.order_id}" 
                                               name="estimated_delivery_time" required
                                               value="14:00">
                                    </div>
                                    
                                    <!-- Priority -->
                                    <div class="form-group">
                                        <label for="priority-${order.order_id}">
                                            <i class="fas fa-flag"></i> Priority Level
                                        </label>
                                        <select id="priority-${order.order_id}" name="processing_priority">
                                            <option value="normal" ${!order.is_urgent ? 'selected' : ''}>Normal</option>
                                            <option value="high">High</option>
                                            <option value="urgent" ${order.is_urgent ? 'selected' : ''}>Urgent</option>
                                            <option value="low">Low</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Installation Required -->
                                    <div class="form-group">
                                        <label for="installation-${order.order_id}">
                                            <i class="fas fa-tools"></i> Installation Required
                                        </label>
                                        <select id="installation-${order.order_id}" name="requires_installation">
                                            <option value="false">No Installation</option>
                                            <option value="true">Installation Required</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Preparation Time -->
                                    <div class="form-group">
                                        <label for="prep-time-${order.order_id}">
                                            <i class="fas fa-stopwatch"></i> Preparation Time (hours)
                                        </label>
                                        <select id="prep-time-${order.order_id}" name="preparation_hours">
                                            <option value="1">1 hour</option>
                                            <option value="2" selected>2 hours</option>
                                            <option value="4">4 hours</option>
                                            <option value="8">8 hours (Next day)</option>
                                            <option value="24">24 hours</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Delivery Instructions -->
                                <div class="form-group">
                                    <label for="delivery-instructions-${order.order_id}">
                                        <i class="fas fa-clipboard-list"></i> Delivery Instructions
                                    </label>
                                    <textarea id="delivery-instructions-${order.order_id}" 
                                              name="delivery_instructions" 
                                              placeholder="Special delivery notes, access instructions, contact person, etc."></textarea>
                                </div>
                                
                                <!-- Installation Instructions (if applicable) -->
                                <div class="form-group">
                                    <label for="installation-instructions-${order.order_id}">
                                        <i class="fas fa-wrench"></i> Installation Instructions
                                    </label>
                                    <textarea id="installation-instructions-${order.order_id}" 
                                              name="installation_instructions" 
                                              placeholder="Special installation requirements, tools needed, preparations, etc."></textarea>
                                </div>
                                
                                <!-- Admin Notes -->
                                <div class="form-group">
                                    <label for="admin-notes-${order.order_id}">
                                        <i class="fas fa-sticky-note"></i> Admin Notes
                                    </label>
                                    <textarea id="admin-notes-${order.order_id}" 
                                              name="admin_notes" 
                                              placeholder="Internal notes for warehouse, driver, customer service, or other staff"></textarea>
                                </div>
                                
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-reject" onclick="rejectOrder('${order.order_id}', '${order.id}')">
                                        <i class="fas fa-times"></i> Reject Order
                                    </button>
                                    <button type="submit" class="btn btn-approve">
                                        <i class="fas fa-check"></i> Approve & Process Order
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        // Create detailed approved order card
        function createDetailedApprovedOrderCard(order) {
            const customerName = order.customers ? order.customers.name : 'Unknown Customer';
            const approvedDate = order.approved_at ? new Date(order.approved_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : 'Unknown';

            const deliveryDate = order.estimated_delivery_date ? new Date(order.estimated_delivery_date).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : 'Not set';

            const priorityBadge = {
                'urgent': { color: '#dc3545', text: 'URGENT' },
                'high': { color: '#fd7e14', text: 'HIGH' },
                'normal': { color: '#28a745', text: 'NORMAL' },
                'low': { color: '#6c757d', text: 'LOW' }
            }[order.processing_priority] || { color: '#28a745', text: 'NORMAL' };

            return `
                <div class="order-card" id="order-card-${order.id}">
                    <div class="order-header" onclick="toggleOrderDetails('${order.id}')">
                        <div>
                            <div class="order-id">
                                <span class="priority-indicator" style="background: ${priorityBadge.color};"></span>
                                ‚úÖ ${order.order_id}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="order-status" style="color: #52c41a; background: #f6ffed; border: 1px solid #b7eb8f;">
                                ${priorityBadge.text} - PROCESSING
                            </div>
                            <button class="btn-delete-small" onclick="deleteOrder(event, '${order.id}', '${order.order_id}')" title="Delete Order">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            <span class="toggle-indicator">‚ñº</span>
                        </div>
                    </div>
                    
                    <div class="order-details" id="details-${order.id}" style="display: none;">
                        <div class="order-meta">
                            <div class="meta-item">
                                <div class="meta-label">Approved</div>
                                <div class="meta-value">${approvedDate}</div>
                            </div>
                             <div class="meta-item">
                                <div class="meta-label">Customer</div>
                                <div class="meta-value">${customerName}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Phone</div>
                                <div class="meta-value">${order.customer_phone || 'N/A'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Address</div>
                                <div class="meta-value">${order.address || 'Address not provided'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Amount</div>
                                <div class="meta-value">RM ${parseFloat(order.amount || 0).toFixed(2)}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Delivery Method</div>
                                <div class="meta-value">${order.driver || 'Not specified'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Assigned Driver</div>
                                <div class="meta-value">${order.assigned_driver || 'Not assigned'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Delivery</div>
                                <div class="meta-value">${deliveryDate} at ${order.estimated_delivery_time || 'Not set'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Installation</div>
                                <div class="meta-value">${order.requires_installation ? 'Required' : 'Not required'}</div>
                            </div>
                        </div>

                        <div id="product-details-container-${order.id}" style="margin-top: 15px;"></div>

                        ${order.delivery_instructions || order.installation_instructions || order.admin_notes ? `
                            <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                ${order.delivery_instructions ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong><i class="fas fa-clipboard-list"></i> Delivery Instructions:</strong>
                                        <div style="margin-top: 5px; color: #666;">${order.delivery_instructions}</div>
                                    </div>
                                ` : ''}
                                ${order.installation_instructions ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong><i class="fas fa-wrench"></i> Installation Instructions:</strong>
                                        <div style="margin-top: 5px; color: #666;">${order.installation_instructions}</div>
                                    </div>
                                ` : ''}
                                ${order.admin_notes ? `
                                    <div>
                                        <strong><i class="fas fa-sticky-note"></i> Admin Notes:</strong>
                                        <div style="margin-top: 5px; color: #666;">${order.admin_notes}</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Send detailed approval notification via n8n
        async function sendDetailedApprovalNotification(order, approvalData) {
            try {
                const customerPhone = order.customers?.phone || order.customer_phone;
                if (!customerPhone) {
                    console.warn('No customer phone number available for WhatsApp notification');
                    return false;
                }

                // Format delivery date and time
                const deliveryDate = new Date(approvalData.estimated_delivery_date).toLocaleDateString('en-MY', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const deliveryTime = approvalData.estimated_delivery_time;
                
                // Format installation info
                const installationText = approvalData.requires_installation 
                    ? '‚úÖ *Installation Included*\n   Our technician will install your products on-site'
                    : 'üì¶ *Delivery Only*\n   Products will be delivered and handed over';
                
                // Format priority badge
                const priorityBadge = {
                    'urgent': 'üö® *URGENT ORDER*',
                    'high': '‚ö° *HIGH PRIORITY*', 
                    'normal': 'üìã *STANDARD ORDER*',
                    'low': 'üìù *LOW PRIORITY*'
                }[approvalData.processing_priority] || 'üìã *STANDARD ORDER*';
                
                // Create detailed approval message
                const approvalMessage = `üéâ *AutoLab Order Approved!*

${priorityBadge}

üìã *ORDER DETAILS:*
‚Ä¢ Order ID: *${order.order_id}*
‚Ä¢ Customer: ${order.customers?.name || 'Valued Customer'}
‚Ä¢ Amount: *RM ${parseFloat(order.amount).toFixed(2)}*

üöö *DELIVERY SCHEDULE:*
‚Ä¢ Date: *${deliveryDate}*
‚Ä¢ Time: *${deliveryTime}*
‚Ä¢ Driver: *${approvalData.assigned_driver}*

üìç *DELIVERY ADDRESS:*
${order.address}

üîß *SERVICE TYPE:*
${installationText}

‚è±Ô∏è *PREPARATION:*
‚Ä¢ Estimated prep time: ${approvalData.preparation_hours} hour(s)
‚Ä¢ Your order is now being prepared

${approvalData.delivery_instructions ? `üìù *DELIVERY NOTES:*\n${approvalData.delivery_instructions}\n\n` : ''}${approvalData.installation_instructions && approvalData.requires_installation ? `üîß *INSTALLATION NOTES:*\n${approvalData.installation_instructions}\n\n` : ''}üìû *WHAT'S NEXT:*
1. Our team will prepare your order
2. Driver will contact you 30 minutes before delivery
3. Please ensure someone is available at the delivery address
4. Have your Order ID ready: *${order.order_id}*

üîÑ *ORDER STATUS UPDATES:*
You'll receive notifications when:
‚Ä¢ Order preparation is completed
‚Ä¢ Driver is dispatched
‚Ä¢ Driver is arriving (30 min notice)

üí¨ *Need to reschedule or have questions?*
Reply to this chat with your Order ID and your message.

Thank you for choosing AutoLab! üöó‚ú®

*Estimated delivery: ${deliveryDate} at ${deliveryTime}*`;

                // Send via n8n
                const payload = {
                    action: 'direct_whatsapp_send',
                    source: 'admin_approval',
                    bypass_routing: true,
                    to: customerPhone,
                    type: 'text',
                    text: {
                        body: approvalMessage
                    },
                    _metadata: {
                        source: 'admin_approval_direct',
                        timestamp: new Date().toISOString(),
                        order_id: order.order_id,
                        approved_by: currentUserDetails?.id
                    }
                };

                console.log('üöÄ Sending detailed approval notification via n8n...');

                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    console.log('‚úÖ Detailed approval notification sent successfully via n8n');
                    return true;
                } else {
                    console.error('‚ùå Failed to send approval notification:', response.status);
                    return false;
                }

            } catch (error) {
                console.error('Error sending detailed approval notification:', error);
                return false;
            }
        }

        // Show success notification
        function showSuccessNotification(message) {
            const notification = document.getElementById('successNotification');
            const messageElement = document.getElementById('notificationMessage');
            
            messageElement.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Reject order function
        async function rejectOrder(orderId, orderDbId) {
            if (!confirm('Are you sure you want to reject this order? This action cannot be undone.')) {
                return;
            }

            try {
                const rejectionReason = prompt('Please provide a reason for rejection:');
                if (!rejectionReason) return;

                const { error } = await supabase
                    .from('orders')
                    .update({
                        status: 'cancelled',
                        admin_notes: `Rejected by admin: ${rejectionReason}`,
                        cancelled_at: new Date().toISOString(),
                        cancelled_by: currentUserDetails?.id
                    })
                    .eq('id', orderDbId);

                if (error) {
                    throw new Error('Failed to reject order: ' + error.message);
                }

                showSuccessNotification('Order has been rejected and customer will be notified.');
                await loadAdminApprovalOrders();
                await loadAllOrderCounts();

            } catch (error) {
                console.error('Error rejecting order:', error);
                alert('Error rejecting order: ' + error.message);
            }
        }

        // Load counts for all tabs on page load
        async function loadAllOrderCounts() {
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .select('status')
                    .in('status', ['awaiting_confirmation', 'pending_payment', 'payment_submitted', 'pending_confirmation', 'processing']);

                if (error) throw error;

                // Reset all counts
                const counts = { awaiting: 0, confirmed: 0, paymentSubmitted: 0, approval: 0, approved: 0 };

                // Tally counts
                data.forEach(order => {
                    if (order.status === 'awaiting_confirmation') counts.awaiting++;
                    else if (order.status === 'pending_payment') counts.confirmed++;
                    else if (order.status === 'payment_submitted') counts.paymentSubmitted++;
                    else if (order.status === 'pending_confirmation') counts.approval++;
                    else if (order.status === 'processing') counts.approved++;
                });

                // Update UI
                document.getElementById('awaiting-count').textContent = counts.awaiting;
                document.getElementById('confirmed-count').textContent = counts.confirmed;
                document.getElementById('payment-submitted-count').textContent = counts.paymentSubmitted;
                document.getElementById('approval-count').textContent = counts.approval;
                document.getElementById('approved-count').textContent = counts.approved;

            } catch (error) {
                console.error('Error loading order counts:', error);
                document.getElementById('awaiting-count').textContent = 'X';
                document.getElementById('confirmed-count').textContent = 'X';
                document.getElementById('payment-submitted-count').textContent = 'X';
                document.getElementById('approval-count').textContent = 'X';
                document.getElementById('approved-count').textContent = 'X';
            }
        }

        // Toggle order details visibility
        function toggleOrderDetails(orderId) {
            const detailsSection = document.getElementById(`details-${orderId}`);
            const orderCard = document.getElementById(`order-card-${orderId}`);
            const toggleIndicator = orderCard.querySelector('.toggle-indicator');
            const orderHeader = orderCard.querySelector('.order-header');

            const isExpanded = detailsSection.style.display === 'block';
            detailsSection.style.display = isExpanded ? 'none' : 'block';
            orderHeader.classList.toggle('expanded', !isExpanded);

            if (!isExpanded) {
                const itemsContainer = document.getElementById(`product-details-container-${orderId}`);
                if (itemsContainer.childElementCount === 0) {
                     itemsContainer.innerHTML = `
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <span>Loading order items...</span>
                        </div>
                    `;
                    fetchOrderItems(orderId);
                }
            }
        }

        // Fetch and render order items
        // Fetch and render order items
async function fetchOrderItems(orderId) {
    const itemsContainer = document.getElementById(`product-details-container-${orderId}`);
    try {
        console.log('üîç Fetching order items for order UUID:', orderId);
        
        const { data: orderItems, error } = await supabase
            .from('order_products')
            .select('*, products(name, category)')
            .eq('order_id', orderId);  // This should be the UUID from orders.id

        console.log('üì¶ Order items found:', orderItems);

        if (error) {
            console.error('‚ùå Error fetching order items:', error);
            throw error;
        }

        if (!orderItems || orderItems.length === 0) {
            console.log('‚ö†Ô∏è No order items found for order UUID:', orderId);
            itemsContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">No products found for this order.</p>';
            return;
        }

        console.log('‚úÖ Found', orderItems.length, 'order items');

        let html = `
            <table class="items-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Category</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
        `;

        orderItems.forEach(item => {
            html += `
                <tr>
                    <td>${item.products?.name || 'Unknown Product'}</td>
                    <td>${item.products?.category || 'N/A'}</td>
                    <td>${item.quantity}</td>
                    <td>RM ${parseFloat(item.unit_price || 0).toFixed(2)}</td>
                    <td>RM ${(item.quantity * item.unit_price).toFixed(2)}</td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        itemsContainer.innerHTML = html;

    } catch (error) {
        console.error('Error fetching order items:', error);
        itemsContainer.innerHTML = `<p style="color: var(--error-color); text-align: center; padding: 10px;">Error loading products: ${error.message}</p>`;
    }
}

        // Delete order function
        async function deleteOrder(event, orderDbId, orderId) {
            event.stopPropagation(); // Prevent card from expanding

            if (!confirm(`Are you sure you want to permanently delete order ${orderId}? This action is irreversible.`)) {
                return;
            }

            try {
                // First, delete related records in order_products
                const { error: productsError } = await supabase
                    .from('order_products')
                    .delete()
                    .eq('order_id', orderDbId);

                if (productsError) {
                    throw new Error(`Failed to delete order items: ${productsError.message}`);
                }

                // Then, delete the order itself
                const { error: orderError } = await supabase
                    .from('orders')
                    .delete()
                    .eq('id', orderDbId);

                if (orderError) {
                    throw new Error(`Failed to delete order: ${orderError.message}`);
                }

                showSuccessNotification(`Order ${orderId} has been successfully deleted.`);

                // Remove the card from the UI
                const orderCard = document.getElementById(`order-card-${orderDbId}`);
                if (orderCard) {
                    orderCard.remove();
                }

                // Refresh counts
                await loadAllOrderCounts();

            } catch (error) {
                console.error('Error deleting order:', error);
                alert('Error deleting order: ' + error.message);
            }
        }

        // Initialize page
        async function initializePage() {
            try {
                const user = await checkAuth();
                if (!user) return;

                const userDetails = await getUserDetails(user.id);
                if (!userDetails) {
                    console.error('Unable to load user details');
                    logout();
                    return;
                }

                updateUserInterface(userDetails);
                
                // Load counts for all tabs first
                await loadAllOrderCounts();
                
                // Load initial data for the active tab
                await loadTabData('admin-approval');
                
                setupEventListeners();

            } catch (err) {
                console.error('Error initializing page:', err);
                alert('Error loading page. Please try again.');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('userAvatar').addEventListener('click', toggleDropdown);

            document.addEventListener('click', function (e) {
                const dropdown = document.getElementById('userDropdown');
                const avatar = document.getElementById('userAvatar');

                if (!avatar.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });

            document.getElementById('logoutButton').addEventListener('click', logout);
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializePage();
        });

        // Make functions globally accessible
        window.rejectOrder = rejectOrder;
        window.rejectPaymentWithWebhook = rejectPaymentWithWebhook;
        window.verifyPaymentWithWebhook = verifyPaymentWithWebhook;
        window.toggleOrderDetails = toggleOrderDetails;
        window.deleteOrder = deleteOrder;
    </script>
</body>
</html>